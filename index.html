<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Google Drive Direct Link Generator</title>
    <style>
        /* --- TEMEL AYARLAR --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f4; margin: 0; padding-bottom: 80px; }
        .container { position: relative; max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .label { font-weight: bold; margin-top: 15px; display: block; margin-bottom: 5px; color: #333; }

        /* --- DİL MENÜSÜ --- */
        .lang-wrapper { position: absolute; top: 20px; right: 20px; z-index: 50; }
        .lang-btn { background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 5px 10px; cursor: pointer; display: flex; align-items: center; gap: 6px; height: 32px; font-weight: 600; color: #333; transition: 0.2s; }
        .lang-btn:hover { background: #f8f9fa; border-color: #bbb; }
        .lang-icon { width: 18px; height: 18px; fill: #0d6efd; display: block; }
        .lang-list { display: none; position: absolute; top: 100%; right: 0; margin-top: 5px; background: white; border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); list-style: none; padding: 0; width: 150px; max-height: 300px; overflow-y: auto; z-index: 100; }
        .lang-list li { padding: 8px 12px; cursor: pointer; border-bottom: 1px solid #f0f0f0; font-size: 13px; }
        .lang-list li:hover { background-color: #f0f0f0; }

        /* --- INPUT --- */
        .input-group { display: flex; align-items: center; margin: 10px 0; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; border-right: none; height: 45px; box-sizing: border-box; transition: border-color 0.3s; font-size: 14px; }
        
        /* Modal Inputs */
        .export-group input, .export-group textarea { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; font-family: inherit; }
        
        .paste-btn { background-color: #6c757d; color: white; border: 1px solid #6c757d; border-radius: 0 4px 4px 0; cursor: pointer; width: 50px; height: 45px; display: flex; align-items: center; justify-content: center; transition: background-color 0.2s; }
        .paste-btn svg { width: 22px; height: 22px; fill: white; }

        .convert-btn { background-color: #0d6efd; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; font-size: 15px; margin-bottom: 5px; font-weight: bold; transition: background 0.1s, transform 0.1s; }
        .convert-btn:hover { background-color: #0b5ed7; }
        .convert-btn.passive { background-color: #adb5bd !important; cursor: not-allowed; pointer-events: none; }
        .convert-btn.success-lock { cursor: default; }
        .convert-btn:active, .convert-btn.fake-active { transform: scale(0.97); background-color: #0a58ca; } 
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 75% { transform: translateX(5px); } 100% { transform: translateX(0); } }
        .error-shake { animation: shake 0.3s ease-in-out; background-color: #dc3545 !important; }

        /* --- INFO TIP --- */
        #infoTip { background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba; padding: 12px 40px 12px 15px; border-radius: 4px; margin-top: 15px; font-size: 13px; position: relative; display: none; }
        .info-close { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); cursor: pointer; font-weight: bold; font-size: 18px; color: #856404; padding: 5px; }

        /* --- CARD VIEW --- */
        #cardsArea { margin-top: 20px; display: none; }
        .result-batch-container { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin-bottom: 20px; }
        
        .batch-header { display: flex; align-items: center; border-bottom: 2px solid #ddd; padding-bottom: 8px; margin-bottom: 10px; gap: 10px; }
        .batch-title { font-weight: bold; font-size: 14px; color: #555; margin: 0; white-space: nowrap; }
        .header-spacer { flex: 1; }
        
        /* SWITCH */
        .switch-container { display: flex; align-items: center; gap: 8px; margin-right: 5px; }
        .switch-label { font-size: 13px; color: #555; font-weight: 500; cursor: pointer; }
        .switch { position: relative; display: inline-block; width: 34px; height: 18px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 14px; width: 14px; left: 2px; bottom: 2px; background-color: white; transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: #0d6efd; }
        input:checked + .slider:before { transform: translateX(16px); }

        .header-expand-btn { background: #6c757d; color: white; border: none; width: 28px; height: 28px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s, transform 0.3s; flex-shrink: 0; }
        .header-expand-btn.rotated { transform: rotate(180deg); }

        .result-row { display: flex; align-items: center; background: #fff; border: 1px solid #ced4da; border-radius: 4px; padding: 8px; margin-bottom: 8px; cursor: pointer; transition: background-color 0.2s; user-select: none; }
        .result-row.selected-row { border-color: #fd7e14; box-shadow: inset 0 0 0 1px #fd7e14; background-color: #fff9f2; }
        
        .card-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; cursor: zoom-in; border: 1px solid #ddd; flex-shrink: 0; }
        .card-link-box { flex: 1; min-width: 0; background: #f1f1f1; border: 1px solid #ddd; padding: 10px; font-size: 13px; color: #333; border-radius: 4px; overflow-x: auto; white-space: nowrap; margin-right: 10px; transition: color 0.2s, background-color 0.2s; font-family: monospace; user-select: text; cursor: text; scrollbar-width: none; }
        .card-link-box::-webkit-scrollbar { display: none; }
        .card-link-box.copied-text { color: #198754; background-color: #d1e7dd; border-color: #badbcc; font-weight: bold; }
        
        .card-actions { display: flex; align-items: center; gap: 8px; flex-shrink: 0; }
        .card-copy-btn { border: none; padding: 0; height: 35px; border-radius: 4px; font-size: 13px; cursor: pointer; white-space: nowrap; transition: background 0.1s; min-width: 90px; text-align: center; font-weight: 500; }
        .card-copy-btn:active { transform: scale(0.96); }
        
        /* Renkler */
        .btn-orange { background-color: #fd7e14; color: white; }
        .btn-green { background-color: #198754; color: white; }
        .btn-grey { background-color: #adb5bd; color: white; }
        .btn-flash { background-color: #fd7e14 !important; transition: none !important; }
        
        .btn-purple { background-color: #6f42c1; color: white; }
        .btn-purple:hover { background-color: #59359a; }

        /* FOOTER */
        .main-footer { margin-top: 0; padding-top: 15px; border-top: 2px solid #eee; display: flex; justify-content: flex-end; }
        .action-bar { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: flex-end; }
        .footer-btn { padding: 8px 10px; border-radius: 4px; cursor: pointer; font-size: 13px; border: none; display: flex; align-items: center; justify-content: center; gap: 5px; font-weight: 500; color: white; min-width: 140px; transition: transform 0.1s; }
        .footer-btn:active { transform: scale(0.95); }

        .btn-red { background-color: #dc3545; } .btn-red-outline { background-color: white; border: 1px solid #dc3545; color: #dc3545; }
        .btn-blue { background-color: #0d6efd; } .btn-excel { background-color: #217346; }

        /* GRID */
        #galleryArea { margin-top: 20px; display: none; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        .gallery-item { position: relative; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; aspect-ratio: 1; background: #eee; cursor: zoom-in; }
        .gallery-item.selected-item { border: 3px solid #fd7e14 !important; transform: scale(0.95); opacity: 0.9; }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; display: block; pointer-events: none; transition: transform 0.2s; }
        .img-copy-anim { transform: scale(1.15) !important; filter: brightness(1.2); }

        .overlay-copy-btn { position: absolute; top: 5px; right: 5px; background: #fd7e14; border: 1px solid #e36906; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0; transition: background 0.2s, opacity 0.2s; z-index: 5; }
        .gallery-item:hover .overlay-copy-btn { opacity: 1; }
        .overlay-copy-btn:hover { background: #e36906; }
        .overlay-copy-btn svg { width: 16px; height: 16px; fill: white; }

        /* MODALS */
        .modal { display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; backdrop-filter: blur(4px); z-index: 1000; }
        #lightboxModal { z-index: 2000; background-color: rgba(0,0,0,0.95); }
        #confirmModal { z-index: 3000; background-color: rgba(0,0,0,0.5); }
        #exportHtmlModal { z-index: 3000; background-color: rgba(0,0,0,0.5); }
        
        .confirm-box { background: white; width: 450px; margin: 10% auto; padding: 20px; border-radius: 8px; text-align: center; }
        .confirm-btns { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .confirm-thumb { width: 60px; height: 60px; object-fit: cover; border: 1px solid #ddd; margin: 2px; }
        
        .export-box { background: white; width: 500px; margin: 5% auto; padding: 25px; border-radius: 8px; text-align: left; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .export-group { margin-bottom: 15px; }
        .export-group label { font-weight: 600; display: block; margin-bottom: 5px; font-size: 14px; }
        .color-options { display: flex; gap: 10px; margin-top: 5px; }
        .color-dot { width: 30px; height: 30px; border-radius: 50%; cursor: pointer; border: 2px solid transparent; transition: transform 0.2s; }
        .color-dot:hover { transform: scale(1.1); }
        .color-dot.selected { border-color: #333; transform: scale(1.1); box-shadow: 0 2px 5px rgba(0,0,0,0.2); }

        .close-modal { position: absolute; top: 20px; right: 30px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 2002; }

        /* LIGHTBOX CONTROLS */
        .lightbox-container { position: absolute; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; }
        .lightbox-img { max-width: 90%; max-height: 80vh; border-radius: 4px; transition: transform 0.1s linear; }
        .lb-btn { position: absolute; background: rgba(255,255,255,0.15); color: white; border: none; padding: 20px; font-size: 30px; top: 50%; transform: translateY(-50%); cursor: pointer; transition: 0.1s; }
        .lb-btn:hover { background: rgba(255,255,255,0.4); }
        .lb-prev { left: 20px; } .lb-next { right: 20px; }
        .hide-nav .lb-btn, .hide-nav .lb-right-group { display: none !important; }
        .lb-active-anim { transform: translateY(-50%) scale(0.85); background: rgba(255,255,255,0.6); }
        .lb-copy-anim { transform: scale(0.95); background: #e36906 !important; }
        .lb-bottom-bar { position: absolute; bottom: 30px; background: rgba(0,0,0,0.7); padding: 10px 25px; border-radius: 40px; display: flex; gap: 20px; align-items: center; }
        .lb-left-group { display: flex; align-items: center; } .lb-center-group { display: flex; gap: 10px; align-items: center; } .lb-right-group { display: flex; gap: 2px; }
        .lb-mini-nav { background: rgba(255,255,255,0.2); color: white; border: none; width: 40px; height: 40px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: 0.1s; }
        .lb-mini-nav:first-child { border-radius: 20px 0 0 20px; } .lb-mini-nav:last-child { border-radius: 0 20px 20px 0; }
        .lb-zoom-btn { background: rgba(255,255,255,0.2); color: white; border: none; width: 35px; height: 35px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; }
        .lb-zoom-group { display: flex; border-radius: 20px; overflow: hidden; margin-right: 10px; }
        .lb-copy { background: #fd7e14; color: white; border: none; padding: 0; height: 40px; border-radius: 20px; cursor: pointer; font-weight: bold; transition: background 0.1s; width: 120px; display: flex; align-items: center; justify-content: center; }
        .lb-copy:hover { background: #e36906; } .lb-copy:active { transform: scale(0.95); }
        .lb-trash { background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; transition: 0.1s; }
    </style>
</head>
<body onclick="handleGlobalClick(event)">

<div id="lightboxModal" class="modal">
    <span class="close-modal" onclick="closeLightbox()">&times;</span>
    <div class="lightbox-container" onclick="closeIfContainerClick(event)">
        <button id="lbPrevBtn" class="lb-btn lb-prev" onclick="changeSlide(-1); event.stopPropagation()">&#10094;</button>
        <img id="lbImage" class="lightbox-img" onclick="event.stopPropagation()">
        <button id="lbNextBtn" class="lb-btn lb-next" onclick="changeSlide(1); event.stopPropagation()">&#10095;</button>
        <div class="lb-bottom-bar" onclick="event.stopPropagation()">
            <div class="lb-left-group"><button id="lbTrashBtn" class="lb-trash" onclick="deleteFromLightbox()" title="Sil"><svg style="width:18px;height:18px;fill:white" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></button></div>
            <div class="lb-center-group">
                <div class="lb-zoom-group"><button class="lb-zoom-btn" onmousedown="startZoom(-0.1)" onmouseup="stopZoom()" onmouseleave="stopZoom()">-</button><button class="lb-zoom-btn" onmousedown="startZoom(0.1)" onmouseup="stopZoom()" onmouseleave="stopZoom()">+</button></div>
                <button class="lb-copy" id="lbCopyBtn" onclick="copyFromLightbox()" title="Kısayol: C">Kopyala</button>
            </div>
            <div class="lb-right-group"><button class="lb-mini-nav" onclick="changeSlide(-1)">&#10094;</button><button class="lb-mini-nav" onclick="changeSlide(1)">&#10095;</button></div>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal" onclick="closeIfBackdrop(event, 'confirmModal')"><div class="confirm-box"><h3 id="confirmTitle" data-lang="confirmTitle">Onay</h3><p id="confirmMsg"></p><div id="confirmImagesContainer" style="display:flex;flex-wrap:wrap;justify-content:center;max-height:150px;overflow:auto;margin:10px 0;"></div><div class="confirm-btns"><button class="footer-btn btn-red" id="btnConfirmYes" data-lang="btnYes">Evet, Sil</button><button class="footer-btn btn-grey" onclick="closeConfirm()" data-lang="btnNo">İptal</button></div></div></div>

<div id="exportHtmlModal" class="modal" onclick="closeIfBackdrop(event, 'exportHtmlModal')">
    <div class="export-box">
        <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid #eee; padding-bottom:10px; margin-bottom:20px;">
            <h3 style="margin:0;">HTML Galeri Oluştur</h3>
            <span style="cursor:pointer; font-size:24px;" onclick="document.getElementById('exportHtmlModal').style.display='none'">&times;</span>
        </div>
        
        <div class="export-group">
            <label>Galeri Başlığı:</label>
            <input type="text" id="htmlTitle" placeholder="Örn: Favori Ürünler">
        </div>
        <div class="export-group">
            <label>Açıklama (Opsiyonel):</label>
            <textarea id="htmlDesc" rows="3" placeholder="Sık kullandığınız resimler için kişisel deponuz..."></textarea>
        </div>
        <div class="export-group">
            <label>Tema Rengi:</label>
            <div class="color-options" id="colorPicker">
                <div class="color-dot selected" style="background:#0d6efd;" onclick="selectColor(this, '#0d6efd')"></div>
                <div class="color-dot" style="background:#fd7e14;" onclick="selectColor(this, '#fd7e14')"></div>
                <div class="color-dot" style="background:#dc3545;" onclick="selectColor(this, '#dc3545')"></div>
                <div class="color-dot" style="background:#198754;" onclick="selectColor(this, '#198754')"></div>
                <div class="color-dot" style="background:#212529;" onclick="selectColor(this, '#212529')"></div>
            </div>
        </div>
        
        <div class="confirm-btns" style="margin-top:30px;">
            <button class="footer-btn btn-purple" onclick="generateStaticPortfolio()">
                <svg style="width:16px;height:16px;fill:white;margin-right:5px;" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
                İndir (.html)
            </button>
            <button class="footer-btn btn-grey" onclick="document.getElementById('exportHtmlModal').style.display='none'">İptal</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="lang-wrapper">
        <button class="lang-btn" id="mainLangBtn" onclick="toggleLangMenu(event)">
            <svg class="lang-icon" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"/></svg>
            <span id="currentLangLabel">TR</span>
        </button>
        <ul class="lang-list" id="langList">
            <li onclick="selectLang('tr')">Türkçe</li><li onclick="selectLang('en')">English</li><li onclick="selectLang('de')">Deutsch</li><li onclick="selectLang('fr')">Français</li><li onclick="selectLang('es')">Español</li><li onclick="selectLang('zh')">中文</li><li onclick="selectLang('hi')">हिन्दी</li><li onclick="selectLang('ar')">العربية</li><li onclick="selectLang('pt')">Português</li><li onclick="selectLang('ru')">Русский</li><li onclick="selectLang('ja')">日本語</li>
        </ul>
    </div>

    <h3 style="margin-top:0;" data-lang="mainTitle">Google Drive Resim Linki Dönüştürücü</h3>
    
    <label class="label" data-lang="labelInput">Normal Drive Linki:</label>
    <div class="input-group">
        <input type="text" id="driveLink" placeholder="Linkleri buraya yapıştırın..." onclick="this.select()" oninput="dinamikKontrol()">
        <button id="btnPaste" class="paste-btn" onclick="yapistir()"><svg style="width:24px;height:24px;fill:white" viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 16H5V5h2v1c0 .55.45 1 1 1h8c.55 0 1-.45 1-1V5h2v14z"/></svg></button>
    </div>
    <button id="btnConvert" class="convert-btn" onclick="linkDonustur()" data-lang="btnConvert">Dönüştür</button>

    <div id="infoTip"><span id="infoText">Direkt resim urllerini kopyalamak istediğiniz resimlerin üzerindeki url simgesini tıklayınız</span><span class="info-close" onclick="closeInfoTip()">&times;</span></div>

    <div id="cardsArea">
        <div class="result-batch-container">
            <div class="batch-header">
                <span id="batchTitle" class="batch-title">Direkt Resim Linkleri</span>
                <div class="header-spacer"></div>
                <div id="viewModeWrapper" class="switch-container" style="display:none;">
                    <span class="switch-label" data-lang="showAll" onclick="document.getElementById('viewModeSwitch').click()">Tümünü Listele</span>
                    <label class="switch">
                        <input type="checkbox" id="viewModeSwitch" onchange="handleSwitchChange()">
                        <span class="slider"></span>
                    </label>
                </div>
                <button id="mainExpandBtn" class="header-expand-btn" onclick="toggleCardListVisibility()">
                    <svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>
                </button>
            </div>
            <div id="cardsList"></div>
        </div>
    </div>

    <div id="galleryArea">
        <label class="label" data-lang="galleryTitle">Tüm Resimler:</label>
        <div class="gallery-grid" id="galleryGrid"></div>
    </div>
    
    <div id="mainFooter" class="main-footer" style="display:none;">
        <div class="action-bar" id="actionBar"></div>
    </div>
</div>

<script>
    let history = []; 
    let lastAddedIds = []; 
    let selectedIds = [];
    let activeLightboxIndex = 0;
    
    let isCardListVisible = true; 
    let listViewMode = 'latest'; 
    let isTipClosed = false;
    let conversionCount = 0;
    let zoomInterval = null;
    let currentZoom = 1;
    let ctrlNumberBuffer = "";
    let isDeleteLocked = false; 
    let selectedThemeColor = "#0d6efd";

    const driveRegex = /drive\.google\.com\/.*?\/d\/([a-zA-Z0-9_-]{25,})/;
    const translations = {
        tr: { mainTitle: "Google Drive Resim Linki Dönüştürücü", galleryTitle: "Tüm Resimler:", showAll: "Tümünü Listele", confirmTitle: "Onay", btnYes: "Evet, Sil", btnNo: "İptal", btnCopy: "Kopyala", msgCopied: "Kopyalandı!", btnExportExcel: "Excel İndir", btnExportHtml: "HTML Galeri", btnExportSel: "Seçilenleri Dışa Aktar", btnExportSelSingle: "Seçileni Dışa Aktar", btnCopyAll: "Tümünü Kopyala", btnCopySel: "Seçilenleri Kopyala", btnCopySelSingle: "Seçileni Kopyala", btnClearAll: "Tümünü Temizle", btnDeleteSelected: "Seçilenleri Sil", titleSingle: "Direkt Resim Linki", titleMulti: "Direkt Resim Linkleri", delRow: "Seçileni Sil", confirmDelOne: "Bu resmi silmek istediğinize emin misiniz?", confirmDelAll: "Tüm resim kayıtları silinecek?", confirmDelSel: "Seçilenleri silmek istiyor musunuz?", btnConvert: "Dönüştür", labelInput: "Normal Drive Linki:", placeholder: "Linkleri buraya yapıştırın...", infoText: "Direkt resim urllerini kopyalamak istediğiniz resimlerin üzerindeki url simgesini tıklayınız" },
        en: { mainTitle: "Google Drive Direct Link Generator", galleryTitle: "All Images:", showAll: "Show All", confirmTitle: "Confirmation", btnYes: "Yes, Delete", btnNo: "Cancel", btnCopy: "Copy", msgCopied: "Copied!", btnExportExcel: "Download Excel", btnExportHtml: "HTML Gallery", btnExportSel: "Export Selected", btnExportSelSingle: "Export Selected", btnCopyAll: "Copy All", btnCopySel: "Copy Selected", btnCopySelSingle: "Copy Selected", btnClearAll: "Clear All", btnDeleteSelected: "Delete Selected", titleSingle: "Direct Link", titleMulti: "Direct Links", delRow: "Delete Selected", confirmDelOne: "Delete this image?", confirmDelAll: "All image records will be deleted?", confirmDelSel: "Delete selected?", btnConvert: "Convert", labelInput: "Original Drive Link:", placeholder: "Paste links here...", infoText: "Click the url icon on the images to copy direct image urls" }
    };
    let currentLang = 'tr';
    const t = () => translations[currentLang] || translations['en'];

    function handleGlobalClick(e) {
        if(e.target.classList.contains('modal')) {
            if(e.target.id==='lightboxModal') closeLightbox();
            if(e.target.id==='confirmModal') closeConfirm();
            if(e.target.id==='exportHtmlModal') document.getElementById('exportHtmlModal').style.display='none';
        }
        if(e.target.id === 'langList' || e.target.closest('.lang-btn')) return;
        document.getElementById("langList").style.display = "none";
        
        if(selectedIds.length > 0) {
            if(!e.target.closest('.gallery-item') && !e.target.closest('.result-row') && !e.target.closest('.action-bar') && !e.target.closest('.confirm-box') && !e.target.closest('#viewModeWrapper') && !e.target.closest('#exportHtmlModal')) {
                selectedIds = []; updateUI(); 
            }
        }
    }
    
    document.addEventListener('keydown', function(e) {
        if(document.getElementById("confirmModal").style.display === "block") {
            if(e.key === "Enter" || e.key === "Delete") { e.preventDefault(); e.stopPropagation(); document.getElementById("btnConfirmYes").click(); return; }
            if(e.key === "Escape" || e.key === "Backspace") { e.preventDefault(); e.stopPropagation(); closeConfirm(); return; }
            return;
        }
        if(document.getElementById("lightboxModal").style.display === "block") { lightboxKeyHandler(e); return; }
        if(document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "TEXTAREA") { if(e.key === "Enter" && document.activeElement.id === "driveLink") linkDonustur(); return; }

        if (e.ctrlKey && e.key >= '0' && e.key <= '9') { e.preventDefault(); ctrlNumberBuffer += e.key; return; }

        if(e.key.toLowerCase() === "p") { yapistir(); animateButton('btnPaste'); }
        if(e.key.toLowerCase() === "e") { 
            if(selectedIds.length>0) exportData(true); else exportData(false);
            animateFooterBtn('btn-excel');
        }
        if(e.key.toLowerCase() === "l") toggleLangMenu(null);
        if(e.key === "Delete" || e.key === "Backspace") {
            if(selectedIds.length>0) confirmDeleteSelected(); else if(history.length>0) confirmClearAll();
            animateFooterBtn('btn-red');
        }
        if(e.ctrlKey && e.key.toLowerCase() === "a") {
            e.preventDefault();
            let visible = (listViewMode === 'latest') ? history.filter(h => lastAddedIds.includes(h.id)) : history;
            selectedIds = visible.map(h => h.id);
            updateUI();
        }
        if(e.key === "ArrowDown") { if(!isCardListVisible) toggleCardListVisibility(); }
        if(e.key === "ArrowUp") { if(isCardListVisible) toggleCardListVisibility(); }
        
        if(e.key.toLowerCase() === "t") {
             if(history.length > lastAddedIds.length) {
                 document.getElementById('viewModeSwitch').checked = !document.getElementById('viewModeSwitch').checked;
                 handleSwitchChange();
             }
        }
    });

    document.addEventListener('keyup', (e) => {
        if (e.key === "Control") {
            if (ctrlNumberBuffer.length > 0) {
                let val = parseInt(ctrlNumberBuffer);
                if (val === 0) { selectedIds = []; updateUI(); } else { let idx = val - 1; handleMultiDigitSelection(idx); }
                ctrlNumberBuffer = "";
            }
        }
    });

    function handleMultiDigitSelection(index) {
        if (index >= 0 && index < history.length) {
            let item = history[index];
            if (listViewMode === 'latest' && !lastAddedIds.includes(item.id)) {
                document.getElementById('viewModeSwitch').checked = true;
                handleSwitchChange();
            }
            if (selectedIds.includes(item.id)) selectedIds = selectedIds.filter(i => i !== item.id);
            else selectedIds.push(item.id);
            updateUI();
        }
    }

    function animateFooterBtn(cls) { let btns = document.querySelectorAll('.footer-btn.' + cls); btns.forEach(b => { b.style.transform = "scale(0.95)"; setTimeout(() => b.style.transform = "scale(1)", 150); }); }
    function animateButton(id) { let b = document.getElementById(id); if(b) { b.style.transform = "scale(0.9)"; setTimeout(() => b.style.transform = "scale(1)", 150); } }
    function toggleLangMenu(e) { if(e) e.stopPropagation(); var l = document.getElementById("langList"); l.style.display = (l.style.display === "block") ? "none" : "block"; }
    function selectLang(c) { currentLang = c; document.getElementById("langList").style.display = "none"; applyTranslations(); }
    
    function applyTranslations() {
        const tObj = translations[currentLang] || translations['en'];
        document.getElementById('currentLangLabel').innerText = currentLang.toUpperCase();
        document.querySelector('[data-lang="mainTitle"]').innerText = tObj.mainTitle;
        document.querySelectorAll('[data-lang]').forEach(el => { if (tObj[el.getAttribute('data-lang')]) el.innerText = tObj[el.getAttribute('data-lang')]; });
        document.getElementById('driveLink').placeholder = tObj.placeholder;
        let lbBtn = document.getElementById("lbCopyBtn");
        if(lbBtn && (lbBtn.style.backgroundColor === "rgb(253, 126, 20)" || lbBtn.style.backgroundColor === "#fd7e14")) lbBtn.innerText = tObj.btnCopy; 
        document.getElementById('infoText').innerText = tObj.infoText;
        updateUI();
    }

    function handleSwitchChange() {
        let chk = document.getElementById('viewModeSwitch');
        listViewMode = chk.checked ? 'all' : 'latest';
        if (listViewMode === 'all' && !isCardListVisible && history.length > 0) isCardListVisible = true;
        history.forEach(h => { if(h.copyState === 'visited') h.copyState = 'default'; });
        if(listViewMode === 'latest') { let hasHidden = selectedIds.some(id => !lastAddedIds.includes(id)); if(hasHidden) selectedIds = []; }
        updateUI();
    }

    function linkDonustur() {
        var input = document.getElementById("driveLink");
        var raw = input.value.trim();
        if(raw === "") return;
        let links = raw.split(',').map(s => s.trim()).filter(s => s !== "");
        let wasEmpty = (history.length === 0);
        lastAddedIds = []; 
        history.forEach(h => { h.copyState = 'default'; });
        let count = 0;
        links.forEach(val => {
            if (val.match(driveRegex)) {
                let id = val.match(driveRegex)[1];
                let link = "https://drive.google.com/thumbnail?id=" + id + "&sz=w10000";
                history = history.filter(item => item.id !== id);
                history.unshift({ id: id, directLink: link, originalLink: val, copyState: 'default' });
                lastAddedIds.push(id);
                count++;
            }
        });
        if(count > 0) {
            conversionCount++;
            isCardListVisible = true; listViewMode = 'latest'; document.getElementById('viewModeSwitch').checked = false; 
            document.getElementById("infoTip").style.display = "none";
            updateUI();
            let btn = document.getElementById("btnConvert");
            btn.classList.add("fake-active"); setTimeout(() => btn.classList.remove("fake-active"), 200); btn.classList.add("success-lock");
        }
    }

    function updateUI() {
        if(history.length === 0) {
            document.getElementById("cardsArea").style.display = "none";
            document.getElementById("galleryArea").style.display = "none";
            document.getElementById("mainFooter").style.display = "none";
            return;
        }
        document.getElementById("cardsArea").style.display = "block";
        document.getElementById("mainFooter").style.display = "flex";

        let itemsToShow = [];
        if(listViewMode === 'latest') {
            itemsToShow = history.filter(h => lastAddedIds.includes(h.id));
            if(itemsToShow.length === 0 && history.length > 0) itemsToShow = history.slice(0, 1);
        } else { itemsToShow = history; }

        let switchWrapper = document.getElementById('viewModeWrapper');
        if (history.length > lastAddedIds.length) switchWrapper.style.display = 'flex'; else switchWrapper.style.display = 'none';

        let listVisibleItems = (listViewMode === 'latest') ? history.filter(h => lastAddedIds.includes(h.id)) : history;
        if (!isCardListVisible && listVisibleItems.length > 0) listVisibleItems = [listVisibleItems[0]];
        let showGrid = false;
        if (!isCardListVisible) showGrid = true;
        else if (listViewMode === 'latest' && conversionCount > 1) showGrid = true;
        let gridVisibleItems = [];
        if (showGrid) gridVisibleItems = (listViewMode === 'latest') ? history.filter(h => lastAddedIds.includes(h.id)) : history;
        let validIds = new Set([...listVisibleItems.map(i => i.id), ...gridVisibleItems.map(i => i.id)]);
        if (selectedIds.length > 0) { let hasHidden = selectedIds.some(id => !validIds.has(id)); if (hasHidden) selectedIds = []; }

        document.getElementById("galleryArea").style.display = showGrid ? "block" : "none";

        const listContainer = document.getElementById("cardsList");
        listContainer.innerHTML = "";
        document.getElementById("batchTitle").innerText = (itemsToShow.length > 1) ? t().titleMulti : t().titleSingle;
        let expandBtn = document.getElementById("mainExpandBtn");
        if(itemsToShow.length > 1) { expandBtn.style.display = "flex"; if(isCardListVisible) expandBtn.classList.add('rotated'); else expandBtn.classList.remove('rotated'); } else { expandBtn.style.display = "none"; }

        itemsToShow.forEach((item, index) => {
            if(!isCardListVisible && index > 0) return;
            let row = document.createElement("div"); 
            row.className = "result-row" + (selectedIds.includes(item.id) ? " selected-row" : "");
            row.onclick = (e) => {
                if(!e.ctrlKey && !e.metaKey && !e.shiftKey) {
                    if(selectedIds.includes(item.id) && selectedIds.length === 1) selectedIds = []; else selectedIds = [item.id]; updateUI();
                } else { handleSelectionAction(e, item.id); }
            };
            let img = document.createElement("img"); img.src = item.directLink; img.className = "card-thumb";
            img.onclick = (e) => { e.stopPropagation(); if(e.ctrlKey || e.metaKey || e.shiftKey) handleSelectionAction(e, item.id); else openLightbox(history.findIndex(h => h.id === item.id), 'popup'); };
            let linkBox = document.createElement("div"); linkBox.className = "card-link-box"; linkBox.innerText = item.directLink;
            if(item.copyState === 'success') linkBox.classList.add('copied-text');
            linkBox.onclick = (e) => { e.stopPropagation(); if(e.ctrlKey || e.metaKey) handleSelectionAction(e, item.id); };
            let actionDiv = document.createElement("div"); actionDiv.className = "card-actions";
            let btn = document.createElement("button"); btn.className = "card-copy-btn"; btn.id = "btnCopy-" + item.id;
            if(item.copyState === 'success') { btn.classList.add('btn-green'); btn.innerText = t().msgCopied; }
            else if(item.copyState === 'visited') { btn.classList.add('btn-grey'); btn.innerText = t().btnCopy; }
            else { btn.classList.add('btn-orange'); btn.innerText = t().btnCopy; }
            btn.onclick = (e) => {
                e.stopPropagation();
                if(e.ctrlKey || e.metaKey || e.shiftKey) { handleSelectionAction(e, item.id); return; }
                if(item.copyState === 'success') { btn.classList.add('btn-flash'); setTimeout(() => btn.classList.remove('btn-flash'), 100); } else { handleCopy(item.id, btn); }
            };
            actionDiv.appendChild(btn); row.appendChild(img); row.appendChild(linkBox); row.appendChild(actionDiv); listContainer.appendChild(row);
        });

        if(showGrid) {
            const grid = document.getElementById("galleryGrid"); grid.innerHTML = "";
            history.forEach((item, index) => {
                let div = document.createElement("div"); div.className = "gallery-item";
                if(selectedIds.includes(item.id)) div.classList.add("selected-item");
                let img = document.createElement("img"); img.src = item.directLink;
                div.onclick = (e) => {
                    if(!e.ctrlKey && !e.metaKey && !e.shiftKey) openLightbox(index, 'gallery');
                    else { if(listViewMode === 'latest' && !lastAddedIds.includes(item.id)) { document.getElementById('viewModeSwitch').checked = true; handleSwitchChange(); } handleSelectionAction(e, item.id); }
                };
                let btnOverlay = document.createElement("div"); btnOverlay.className = "overlay-copy-btn";
                btnOverlay.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>';
                btnOverlay.onclick = (e) => {
                    e.stopPropagation();
                    if(e.ctrlKey || e.metaKey || e.shiftKey) { handleSelectionAction(e, item.id); return; }
                    navigator.clipboard.writeText(item.directLink).then(() => {
                         btnOverlay.style.background = "#198754"; setTimeout(() => btnOverlay.style.background = "#fd7e14", 500);
                         img.classList.add('img-copy-anim'); setTimeout(() => img.classList.remove('img-copy-anim'), 300);
                    });
                };
                div.appendChild(img); div.appendChild(btnOverlay); grid.appendChild(div);
            });
        }
        renderFooter();
    }

    function renderFooter() {
        const bar = document.getElementById("actionBar"); bar.innerHTML = "";
        let len = selectedIds.length;
        if(len > 0) {
            bar.appendChild(createBtn(t().btnExportSel, "btn-excel", () => exportData(true)));
            bar.appendChild(createBtn(t().btnCopySel, "btn-blue", () => copyData(true)));
            bar.appendChild(createBtn(t().btnDeleteSelected + " (" + len + ")", "btn-red", confirmDeleteSelected));
        } else {
            bar.appendChild(createBtn(t().btnExportExcel, "btn-excel", () => exportData(false)));
            bar.appendChild(createBtn(t().btnExportHtml, "btn-purple", openHtmlExportModal)); 
            bar.appendChild(createBtn(t().btnCopyAll, "btn-blue", () => copyData(false)));
            bar.appendChild(createBtn(t().btnClearAll, "btn-red-outline", confirmClearAll));
        }
    }

    function createBtn(text, cls, cb) { let b = document.createElement("button"); b.className = "footer-btn " + cls; b.innerText = text; b.onclick = cb; return b; }
    function handleSelectionAction(e, id) {
        let isCtrl = e ? (e.ctrlKey || e.metaKey) : false; if(e===null) isCtrl=true; let isShift = e ? e.shiftKey : false;
        if (!isCtrl && !isShift) { selectedIds = [id]; } 
        else if (isCtrl) { if(selectedIds.includes(id)) selectedIds = selectedIds.filter(i => i !== id); else selectedIds.push(id); } 
        else if (isShift && selectedIds.length > 0) { 
             let lastId = selectedIds[selectedIds.length-1]; let start = history.findIndex(h => h.id === lastId); let end = history.findIndex(h => h.id === id); 
             let s = Math.min(start, end); let f = Math.max(start, end); for(let i=s; i<=f; i++) { if(!selectedIds.includes(history[i].id)) selectedIds.push(history[i].id); } 
        } else { selectedIds = [id]; } updateUI();
    }
    function toggleCardListVisibility() { isCardListVisible = !isCardListVisible; updateUI(); }
    function handleCopy(id, btnElement) {
        let item = history.find(h => h.id === id); history.forEach(h => { if(h.copyState === 'success' && h.id !== id) h.copyState = 'visited'; });
        navigator.clipboard.writeText(item.directLink).then(() => { item.copyState = 'success'; updateUI(); });
    }
    function copyData(sel) { let src = sel ? history.filter(h => selectedIds.includes(h.id)) : history; navigator.clipboard.writeText(src.map(h => h.directLink).join("\n")); }
    
    // --- EXCEL EXPORT ---
    function exportData(sel) {
        let src = sel ? history.filter(h => selectedIds.includes(h.id)) : history;
        let langCode = currentLang.toUpperCase();
        let html = `<html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40"><head><meta charset='UTF-8'><style>td{vertical-align:middle;}</style></head><body><table border="1"><thead><tr><th style="background-color:#f0f0f0;">Image</th><th style="background-color:#f0f0f0;">Direct Link</th><th style="background-color:#f0f0f0;">Original Link</th><th style="background-color:#f0f0f0;">Copy Action</th><th style="background-color:#f0f0f0;">Delete Action</th><th></th><th></th><th></th><th></th><th></th><th style="background-color:#ffff00;">${langCode}</th></tr></thead><tbody>`;
        src.forEach(item => { html += `<tr height="80"><td align="center" valign="middle"><img src="${item.directLink}" width="80" height="80"></td><td valign="middle"><a href="${item.directLink}">${item.directLink}</a></td><td valign="middle"><a href="${item.originalLink}">${item.originalLink}</a></td><td></td><td></td></tr>`; });
        html += `</tbody></table></body></html>`;
        let blob = new Blob([html], {type:'application/vnd.ms-excel'});
        let a = document.createElement("a"); a.href=URL.createObjectURL(blob); a.download="drive_links_" + langCode + ".xls"; a.click();
    }

    // --- HTML EXPORT LOGIC (V63 UPDATED) ---
    function openHtmlExportModal() { document.getElementById('exportHtmlModal').style.display='block'; }
    function selectColor(el, color) { selectedThemeColor = color; document.querySelectorAll('.color-dot').forEach(d => d.classList.remove('selected')); el.classList.add('selected'); }
    
    function generateStaticPortfolio() {
        const title = document.getElementById('htmlTitle').value || "Resim Galerisi";
        const desc = document.getElementById('htmlDesc').value || "";
        const items = history; 
        
        // CSS FOR EXPORTED FILE
        const css = `
            body{font-family:'Segoe UI',sans-serif;background:#f4f4f4;margin:0;padding:20px}
            .container{max-width:1000px;margin:0 auto;background:white;padding:20px;border-radius:8px;box-shadow:0 4px 15px rgba(0,0,0,0.1)}
            .header{text-align:center;margin-bottom:30px;padding-bottom:20px;border-bottom:1px solid #eee}
            .header h1{margin:0;color:${selectedThemeColor}}
            .header p{color:#666;margin-top:10px}
            .view-controls{text-align:right;margin-bottom:10px}
            .btn{padding:8px 15px;background:#eee;border:none;border-radius:4px;cursor:pointer;font-weight:600}
            .btn.active{background:${selectedThemeColor};color:white}
            /* GRID MODE */
            .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:15px}
            .item{position:relative;border-radius:6px;border:1px solid #ddd;background:#fff;overflow:hidden}
            /* Default Grid Style */
            .item-inner{aspect-ratio:1;cursor:zoom-in;position:relative}
            .item img{width:100%;height:100%;object-fit:cover;display:block;transition:0.3s}
            .item:hover img{transform:scale(1.05)}
            .overlay-btn{position:absolute;top:5px;right:5px;width:30px;height:30px;background:${selectedThemeColor};border-radius:50%;display:flex;align-items:center;justify-content:center;opacity:0;transition:0.2s;cursor:pointer;z-index:5}
            .item:hover .overlay-btn{opacity:1}
            .overlay-btn svg{width:16px;height:16px;fill:white}
            .list-details{display:none} /* Hidden in Grid */
            /* LIST MODE OVERRIDES */
            .list-mode.grid{display:block}
            .list-mode .item{display:flex;align-items:center;padding:10px;margin-bottom:10px;aspect-ratio:auto}
            .list-mode .item-inner{width:60px;height:60px;aspect-ratio:auto;margin-right:15px;flex-shrink:0}
            .list-mode .item:hover img{transform:none}
            .list-mode .overlay-btn{display:none}
            .list-mode .list-details{display:flex;flex:1;gap:10px;align-items:center;min-width:0}
            .link-box{flex:1;background:#f1f1f1;border:1px solid #ddd;padding:10px;font-family:monospace;font-size:13px;border-radius:4px;white-space:nowrap;overflow-x:auto;scrollbar-width:none}
            .copy-btn{padding:8px 15px;background:${selectedThemeColor};color:white;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:500;min-width:90px;height:38px}
            .copy-btn.success{background:#198754}
            /* LIGHTBOX */
            .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.95);z-index:2000;justify-content:center;align-items:center}
            .modal img{max-width:90%;max-height:85vh;border-radius:4px}
            .close{position:absolute;top:20px;right:30px;color:#f1f1f1;font-size:40px;cursor:pointer;font-weight:bold;z-index:2002}
            .nav{position:absolute;top:50%;color:white;font-size:40px;padding:20px;cursor:pointer;user-select:none;transform:translateY(-50%);background:rgba(255,255,255,0.1);z-index:2001}
            .nav:hover{background:rgba(255,255,255,0.3)}
            .prev{left:20px} .next{right:20px}
            .lb-btn-container{position:absolute;bottom:30px;background:rgba(0,0,0,0.6);padding:10px 20px;border-radius:30px;z-index:2002}
            .lb-copy{background:${selectedThemeColor};color:white;border:none;padding:10px 25px;border-radius:20px;cursor:pointer;font-weight:bold;min-width:100px}
            .lb-copy.success{background:#198754}
            .footer-link{text-align:center;margin-top:30px;font-size:12px}
            .footer-link a{color:#999;text-decoration:none} .footer-link a:hover{text-decoration:underline}
        `;

        // JS FOR EXPORTED FILE
        const script = `
            let items = ${JSON.stringify(items.map(i => i.directLink))};
            let currentIndex = 0;
            function openLb(idx){ currentIndex=idx; document.getElementById('lbImg').src=items[idx]; document.getElementById('modal').style.display='flex'; resetLbBtn(); }
            function closeLb(){ document.getElementById('modal').style.display='none'; }
            function nav(d){ currentIndex+=d; if(currentIndex<0)currentIndex=items.length-1; if(currentIndex>=items.length)currentIndex=0; document.getElementById('lbImg').src=items[currentIndex]; resetLbBtn(); }
            function resetLbBtn(){ let b=document.getElementById('lbCopyBtn'); b.innerText='Kopyala'; b.classList.remove('success'); }
            
            function setView(mode){ 
                const g = document.getElementById('gallery'); 
                const btns = document.querySelectorAll('.view-controls .btn');
                btns.forEach(b=>b.classList.remove('active'));
                if(mode==='list'){ g.classList.add('list-mode'); btns[1].classList.add('active'); }
                else{ g.classList.remove('list-mode'); btns[0].classList.add('active'); }
            }
            
            function copyText(txt, btn){
                navigator.clipboard.writeText(txt).then(()=>{
                    if(btn.id === 'lbCopyBtn'){
                        btn.innerText = 'Kopyalandı'; btn.classList.add('success');
                        setTimeout(resetLbBtn, 1500);
                    }
                    else if(btn.classList.contains('overlay-btn')){
                        btn.style.backgroundColor = '#198754';
                        setTimeout(()=>btn.style.backgroundColor='${selectedThemeColor}', 1500);
                    }
                    else {
                        let oldText = btn.innerText; btn.innerText = 'Kopyalandı'; btn.classList.add('success');
                        setTimeout(()=>{ btn.innerText=oldText; btn.classList.remove('success'); }, 1500);
                    }
                });
            }
            
            function copyCurrentLb(){ copyText(items[currentIndex], document.getElementById('lbCopyBtn')); }

            document.addEventListener('keydown', e => {
                if(document.getElementById('modal').style.display==='flex'){
                    if(e.key==='Escape') closeLb();
                    if(e.key==='ArrowRight') nav(1);
                    if(e.key==='ArrowLeft') nav(-1);
                }
            });
        `;

        let htmlContent = `
        <!DOCTYPE html>
        <html lang="tr">
        <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>${title}</title><style>${css}</style></head>
        <body>
            <div class="container">
                <div class="header">
                    <h1>${title}</h1>
                    <p>${desc}</p>
                </div>
                <div class="view-controls">
                    <button class="btn active" onclick="setView('grid')">Izgara</button>
                    <button class="btn" onclick="setView('list')">Liste</button>
                </div>
                <div id="gallery" class="grid">
                    ${items.map((item, idx) => `
                        <div class="item">
                            <div class="item-inner" onclick="openLb(${idx})">
                                <img src="${item.directLink}" loading="lazy">
                                <div class="overlay-btn" onclick="event.stopPropagation(); copyText('${item.directLink}', this)">
                                    <svg viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>
                                </div>
                            </div>
                            <div class="list-details">
                                <input class="link-box" readonly value="${item.directLink}" onclick="this.select()">
                                <button class="copy-btn" onclick="copyText('${item.directLink}', this)">Kopyala</button>
                            </div>
                        </div>
                    `).join('')}
                </div>
                <div class="footer-link">
                    <a href="https://sites.google.com/view/drive-resim-linki-donusturucu" target="_blank">Drive Resim Linki Dönüştürücü ile oluşturuldu</a>
                </div>
            </div>
            
            <div id="modal" class="modal" onclick="if(event.target===this)closeLb()">
                <span class="close" onclick="closeLb()">&times;</span>
                <span class="nav prev" onclick="nav(-1)">&#10094;</span>
                <img id="lbImg" src="">
                <span class="nav next" onclick="nav(1)">&#10095;</span>
                <div class="lb-btn-container">
                    <button id="lbCopyBtn" class="lb-copy" onclick="copyCurrentLb()">Kopyala</button>
                </div>
            </div>
            <script>${script}<\/script>
        </body>
        </html>`;

        let blob = new Blob([htmlContent], {type:'text/html'});
        let a = document.createElement("a");
        a.href = URL.createObjectURL(blob);
        a.download = "portfolio.html";
        a.click();
        
        document.getElementById('exportHtmlModal').style.display='none';
    }

    function confirmDeleteSelected() { showConfirm(t().confirmDelSel, history.filter(h => selectedIds.includes(h.id)).map(h=>h.directLink), () => { history = history.filter(h => !selectedIds.includes(h.id)); selectedIds = []; updateUI(); }); }
    function confirmClearAll() { showConfirm(t().confirmDelAll, null, () => { history = []; lastAddedIds = []; selectedIds = []; conversionCount=0; updateUI(); }); }
    function showConfirm(msg, imgs, cb) { 
        document.getElementById("confirmModal").style.display = "block"; document.getElementById("confirmMsg").innerText = msg; 
        document.querySelector('[data-lang="confirmTitle"]').innerText = t().confirmTitle;
        document.getElementById("btnConfirmYes").innerText = t().btnYes;
        document.querySelector('.footer-btn.btn-grey').innerText = t().btnNo;
        let c = document.getElementById("confirmImagesContainer"); c.innerHTML="";
        if(imgs) imgs.forEach(src=>{let i=document.createElement("img");i.src=src;i.className="confirm-thumb";c.appendChild(i);});
        document.getElementById("btnConfirmYes").onclick = () => { cb(); closeConfirm(); }; 
    }
    function closeConfirm() { document.getElementById("confirmModal").style.display = "none"; }
    function closeInfoTip() { document.getElementById("infoTip").style.display = "none"; isTipClosed = true; }
    
    // LIGHTBOX
    function closeLightbox() { document.getElementById("lightboxModal").style.display = "none"; window.removeEventListener('keydown', lightboxKeyHandler); }
    function openLightbox(idx, mode = 'gallery') { 
        activeLightboxIndex = idx; 
        const m = document.getElementById("lightboxModal");
        document.getElementById("lbImage").src = history[idx].directLink; 
        m.style.display = "block"; 
        let lbBtn = document.getElementById("lbCopyBtn");
        lbBtn.innerText = t().btnCopy;
        lbBtn.style.backgroundColor = "#fd7e14"; 
        if(mode === 'popup') m.classList.add('hide-nav'); else m.classList.remove('hide-nav');
        window.addEventListener('keydown', lightboxKeyHandler);
        currentZoom = 1; document.getElementById("lbImage").style.transform = `scale(1)`;
        m.onwheel = (e) => { e.preventDefault(); if(e.deltaY < 0) zoomImage(0.1); else zoomImage(-0.1); };
    }
    
    function copyFromLightbox() {
        navigator.clipboard.writeText(history[activeLightboxIndex].directLink);
        let btn = document.getElementById("lbCopyBtn");
        if (btn.style.backgroundColor === "rgb(25, 135, 84)" || btn.style.backgroundColor === "#198754") {
            btn.style.backgroundColor = "#fd7e14"; setTimeout(() => btn.style.backgroundColor = "#198754", 150);
        } else {
            btn.innerText = t().msgCopied; btn.style.backgroundColor = "#198754";
        }
    }

    function lightboxKeyHandler(e) {
        if(document.getElementById("lightboxModal").style.display !== "block") return;
        if(e.key === "Escape") { closeLightbox(); return; }
        if(e.key.toLowerCase() === "c") { copyFromLightbox(); let btn = document.getElementById("lbCopyBtn"); if(btn) { btn.classList.add("lb-copy-anim"); setTimeout(()=>btn.classList.remove("lb-copy-anim"), 200); } return; }
        if(e.key === "Delete" || e.key === "Backspace") { deleteFromLightbox(); animateButton('lbTrashBtn'); return; }
        if(e.key === "+" || e.key === "=") { startZoom(0.1); return; }
        if(e.key === "-" || e.key === "_") { startZoom(-0.1); return; }
        if(document.getElementById("lightboxModal").classList.contains('hide-nav')) return;
        if(e.key === "ArrowRight") { changeSlide(1); animateButton('lbNextBtn'); }
        if(e.key === "ArrowLeft") { changeSlide(-1); animateButton('lbPrevBtn'); }
    }
    document.addEventListener('keyup', (e)=>{ if(e.key==="+"||e.key==="="||e.key==="-"||e.key==="_") stopZoom(); });

    function changeSlide(d) { 
        activeLightboxIndex+=d; if(activeLightboxIndex<0) activeLightboxIndex=history.length-1; if(activeLightboxIndex>=history.length) activeLightboxIndex=0; 
        document.getElementById("lbImage").src=history[activeLightboxIndex].directLink; 
        currentZoom=1; document.getElementById("lbImage").style.transform = `scale(1)`; 
        let btn = document.getElementById("lbCopyBtn");
        btn.innerText = t().btnCopy;
        btn.style.backgroundColor = "#fd7e14";
    }
    
    function deleteFromLightbox() { 
        if(isDeleteLocked) return; 
        let item = history[activeLightboxIndex];
        showConfirm(t().confirmDelOne, [item.directLink], () => {
            history.splice(activeLightboxIndex, 1); 
            if(history.length===0) closeLightbox(); 
            else { 
                if(activeLightboxIndex >= history.length) activeLightboxIndex=history.length-1; 
                document.getElementById("lbImage").src=history[activeLightboxIndex].directLink; 
                let btn = document.getElementById("lbCopyBtn");
                btn.innerText = t().btnCopy;
                btn.style.backgroundColor = "#fd7e14";
                isDeleteLocked = true; setTimeout(() => { isDeleteLocked = false; }, 500);
            } 
            updateUI(); 
        });
    }
    
    function startZoom(val) { if(zoomInterval) return; zoomImage(val); zoomInterval = setInterval(()=>zoomImage(val), 100); }
    function stopZoom() { clearInterval(zoomInterval); zoomInterval = null; }
    function zoomImage(val) { currentZoom += val; if(currentZoom < 0.5) currentZoom = 0.5; if(currentZoom > 5) currentZoom = 5; document.getElementById("lbImage").style.transform = `scale(${currentZoom})`; }
    
    function dinamikKontrol() { document.getElementById("btnConvert").classList.remove("success-lock"); }
    
    async function yapistir() { 
        try { 
            let text = await navigator.clipboard.readText();
            document.getElementById("driveLink").value = text;
            let btn = document.getElementById("btnConvert");
            btn.classList.add("fake-active");
            setTimeout(() => btn.classList.remove("fake-active"), 150);
            linkDonustur(); 
        } catch(e){} 
    }
    
    function closeIfBackdrop(e, id) { if(e.target.id === id) document.getElementById(id).style.display = "none"; }
    function closeIfContainerClick(e) { if(e.target.classList.contains("lightbox-container")) closeLightbox(); }
</script>
</body>
</html>
