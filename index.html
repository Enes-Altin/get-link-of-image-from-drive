<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Drive Gallery Pro V36</title>
    <style>
        /* --- TEMEL AYARLAR --- */
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; padding: 20px; background-color: #f4f4f4; margin: 0; }
        .container { position: relative; max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .label { font-weight: bold; margin-top: 15px; display: block; margin-bottom: 5px; color: #333; }

        /* --- DİL MENÜSÜ --- */
        .lang-wrapper { position: absolute; top: 20px; right: 20px; z-index: 50; }
        .lang-btn {
            background: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 5px 10px; cursor: pointer;
            font-size: 13px; font-weight: 600; color: #333; display: flex; align-items: center; justify-content: center;
            gap: 6px; height: 32px; transition: background 0.2s;
        }
        .lang-btn:hover { background: #f8f9fa; border-color: #bbb; }
        .lang-icon { width: 16px; height: 16px; fill: #333; display: block; }
        .lang-list {
            display: none; position: absolute; top: 100%; right: 0; margin-top: 5px; background: white;
            border: 1px solid #ddd; border-radius: 4px; box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            list-style: none; padding: 0; width: 150px; max-height: 300px; overflow-y: auto;
        }
        .lang-list li { padding: 8px 12px; cursor: pointer; font-size: 13px; border-bottom: 1px solid #f0f0f0; color: #333; }
        .lang-list li:hover { background-color: #f0f0f0; }

        /* --- INPUT --- */
        .input-group { display: flex; align-items: center; margin: 10px 0; }
        input[type="text"] { 
            flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 4px 0 0 4px; border-right: none; height: 45px; box-sizing: border-box; transition: border-color 0.3s; font-size: 14px;
        }
        button:active { transform: scale(0.96); }
        .paste-btn {
            background-color: #6c757d; color: white; border: 1px solid #6c757d; border-radius: 0 4px 4px 0;
            cursor: pointer; width: 50px; height: 45px; display: flex; align-items: center; justify-content: center;
            transition: background-color 0.2s, transform 0.2s; padding: 0;
        }
        .paste-btn:hover { background-color: #5c636a; }
        .paste-btn svg { width: 22px; height: 22px; fill: white; }

        .convert-btn { 
            background-color: #0d6efd; color: white; padding: 12px 20px; border: none; border-radius: 4px; cursor: pointer; width: 100%; 
            font-size: 15px; margin-bottom: 5px; font-weight: bold; transition: background-color 0.3s, transform 0.2s;
        }
        .convert-btn:hover { background-color: #0b5ed7; }
        .convert-btn.passive { background-color: #adb5bd !important; cursor: not-allowed; transform: none !important; pointer-events: none; }
        .convert-btn.success-lock:active { transform: none !important; } .convert-btn.success-lock { cursor: default; }
        @keyframes shake { 0% { transform: translateX(0); } 25% { transform: translateX(-5px); } 50% { transform: translateX(5px); } 75% { transform: translateX(-5px); } 100% { transform: translateX(0); } }
        .error-shake { animation: shake 0.3s ease-in-out; background-color: #dc3545 !important; }

        /* --- INFO TIP --- */
        #infoTip {
            background-color: #fff3cd; color: #856404; border: 1px solid #ffeeba;
            padding: 12px 40px 12px 15px; border-radius: 4px; margin-top: 15px;
            font-size: 13px; position: relative; display: none;
            animation: fadeIn 0.3s ease-in;
        }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-5px); } to { opacity: 1; transform: translateY(0); } }
        .info-close {
            position: absolute; right: 10px; top: 50%; transform: translateY(-50%);
            cursor: pointer; font-weight: bold; font-size: 18px; color: #856404; padding: 5px;
        }
        .info-close:hover { color: #533f03; }

        /* --- CARD VIEW --- */
        #cardsArea { margin-top: 20px; display: none; }
        .result-batch-container {
            background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 15px; margin-bottom: 20px;
        }
        .batch-title {
            font-weight: bold; font-size: 14px; margin-bottom: 10px; color: #555; border-bottom: 2px solid #ddd; padding-bottom: 5px;
        }
        
        .result-row {
            display: flex; align-items: center; 
            background: #fff; border: 1px solid #ced4da; border-radius: 4px; padding: 8px; margin-bottom: 8px;
        }
        .card-thumb {
            width: 60px; height: 60px; object-fit: cover; border-radius: 4px; margin-right: 15px; cursor: zoom-in;
            border: 1px solid #ddd; flex-shrink: 0;
        }
        
        .card-link-box {
            flex: 1; min-width: 0;
            background: #f1f1f1; border: 1px solid #ddd; padding: 10px; font-size: 13px; color: #333; 
            border-radius: 4px; overflow: hidden; white-space: nowrap; text-overflow: ellipsis;
            margin-right: 10px; transition: color 0.2s, background-color 0.2s;
            font-family: monospace;
        }
        
        /* Kalıcı Yeşil Stil */
        .card-link-box.copied-text { color: #198754; background-color: #d1e7dd; border-color: #badbcc; font-weight: bold; }
        
        .card-actions { 
            display: flex; align-items: center; gap: 8px; 
            flex-shrink: 0; 
        }

        .card-copy-btn {
            background-color: #fd7e14; color: white; border: none; padding: 8px 15px; 
            border-radius: 4px; font-size: 13px; cursor: pointer; white-space: nowrap;
            transition: background-color 0.1s, transform 0.1s; min-width: 90px; text-align: center;
        }
        .card-copy-btn:hover { background-color: #e36906; }
        .card-copy-btn:active { transform: scale(0.96); }
        /* Kalıcı Yeşil Buton */
        .card-copy-btn.success-copy { background-color: #198754 !important; }
        .card-copy-btn.success-copy:hover { background-color: #157347 !important; }

        .expand-btn {
            background: #6c757d; color: white; border: none; width: 32px; height: 32px; border-radius: 50%;
            cursor: pointer; display: flex; align-items: center; justify-content: center;
            transition: background 0.2s, transform 0.3s;
        }
        .expand-btn:hover { background: #5c636a; }
        .expand-btn svg { width: 14px; height: 14px; fill: white; }
        .expand-btn.rotated { transform: rotate(180deg); }

        /* --- GALERİ GRID --- */
        #galleryArea { margin-top: 20px; display: none; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 10px; margin-top: 10px; }
        .gallery-item {
            position: relative; border: 1px solid #ddd; border-radius: 6px; overflow: hidden; aspect-ratio: 1; background: #eee;
            cursor: zoom-in; transition: transform 0.2s, border-color 0.2s; user-select: none;
        }
        .gallery-item:hover { transform: scale(1.02); }
        .gallery-item img { width: 100%; height: 100%; object-fit: cover; display: block; pointer-events: none; }
        
        .gallery-item.selected-item { border: 3px solid #fd7e14 !important; transform: scale(0.95); opacity: 0.9; }
        
        .overlay-copy-btn {
            position: absolute; top: 5px; right: 5px; background: rgba(255, 255, 255, 0.9);
            border: 1px solid #ccc; border-radius: 50%; width: 28px; height: 28px;
            display: flex; align-items: center; justify-content: center; cursor: pointer; opacity: 0;
            transition: opacity 0.2s; z-index: 5; pointer-events: auto;
        }
        .gallery-item:hover .overlay-copy-btn { opacity: 1; }
        .overlay-copy-btn:hover { background: #fd7e14; border-color: #fd7e14; color: white; }
        .overlay-copy-btn svg { width: 14px; height: 14px; fill: currentColor; }

        /* Batch Controls */
        .batch-controls { margin-top: 20px; padding-top: 15px; border-top: 1px solid #eee; display: flex; justify-content: space-between; display: none; }
        .btn-outline-danger { background: white; border: 1px solid #dc3545; color: #dc3545; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        .btn-outline-danger:hover { background: #dc3545; color: white; }
        .btn-primary-soft { background: #e7f1ff; border: 1px solid #0d6efd; color: #0d6efd; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; font-weight: 600; }
        .btn-primary-soft:hover { background: #0d6efd; color: white; }
        .btn-delete-selected { background: #dc3545; color: white; border: none; padding: 6px 12px; border-radius: 4px; cursor: pointer; font-size: 13px; display: none; margin-right: auto; }
        .btn-delete-selected:hover { background: #bb2d3b; }

        /* --- MODALS --- */
        .modal { display: none; position: fixed; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; backdrop-filter: blur(4px); }
        #detailsModal { z-index: 1000; background-color: rgba(0,0,0,0.6); }
        #lightboxModal { z-index: 2000; background-color: rgba(0,0,0,0.95); }
        #confirmModal { z-index: 3000; background-color: rgba(0,0,0,0.5); }

        /* --- LIGHTBOX --- */
        .lightbox-container { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); display: flex; align-items: center; justify-content: center; width: 100%; height: 100%; cursor: pointer; }
        .lightbox-img { max-width: 90%; max-height: 80vh; border-radius: 4px; box-shadow: 0 0 30px rgba(0,0,0,0.5); transition: transform 0.1s linear; cursor: default; }
        .lb-btn { position: absolute; background: rgba(255,255,255,0.15); color: white; border: none; cursor: pointer; padding: 20px; font-size: 30px; border-radius: 5px; top: 50%; transform: translateY(-50%); transition: background 0.2s, transform 0.1s; user-select: none; }
        .lb-btn:hover { background: rgba(255,255,255,0.4); }
        .lb-prev { left: 20px; } .lb-next { right: 20px; }
        .hide-nav .lb-btn, .hide-nav .lb-right-group { display: none !important; }
        .lb-bottom-bar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; justify-content: space-between; align-items: center; background: rgba(0,0,0,0.7); padding: 10px 25px; border-radius: 40px; width: auto; min-width: 320px; gap: 30px; cursor: default; }
        .lb-left-group { display: flex; align-items: center; } .lb-center-group { display: flex; gap: 10px; align-items: center; justify-content: center; flex: 1; } .lb-right-group { display: flex; gap: 2px; align-items: center; } 
        .lb-mini-nav { background: rgba(255,255,255,0.2); color: white; border: none; width: 40px; height: 40px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: background 0.2s, transform 0.1s; }
        .lb-mini-nav:hover { background: rgba(255,255,255,0.4); }
        .lb-right-group .lb-mini-nav:first-child { border-radius: 20px 0 0 20px; } .lb-right-group .lb-mini-nav:last-child { border-radius: 0 20px 20px 0; }
        .lb-zoom-btn { background: rgba(255,255,255,0.2); color: white; border: none; width: 35px; height: 35px; cursor: pointer; font-size: 20px; display: flex; align-items: center; justify-content: center; user-select: none; }
        .lb-zoom-btn:hover { background: rgba(255,255,255,0.4); }
        .lb-zoom-btn:active { background: rgba(255,255,255,0.6); }
        .lb-zoom-group { display: flex; border-radius: 20px; overflow: hidden; margin-right: 10px;}
        .lb-copy { background: #fd7e14; color: white; padding: 0 20px; height: 40px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; transition: background 0.2s, transform 0.1s; white-space: nowrap; font-size: 14px; }
        .lb-copy:hover { background: #e36906; } .lb-copy:active { transform: scale(0.95); }
        .lb-trash { background: rgba(220, 53, 69, 0.8); color: white; width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s, transform 0.1s; }
        .lb-trash:hover { background: #dc3545; } .lb-trash:active { transform: scale(0.9); }
        .lb-trash svg { width: 18px; height: 18px; fill: white; }
        .close-modal { position: absolute; top: 20px; right: 30px; color: #f1f1f1; font-size: 40px; font-weight: bold; cursor: pointer; z-index: 2002; }

        /* --- DETAY TABLOSU --- */
        .details-modal-content { background-color: #fefefe; margin: 5% auto; border: 1px solid #888; width: 90%; max-width: 800px; border-radius: 8px; display: flex; flex-direction: column; max-height: 90vh; }
        .details-header { padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .details-body { overflow-y: auto; padding: 20px; scrollbar-width: thin; scrollbar-color: #ccc #f1f1f1; }
        .details-body::-webkit-scrollbar { width: 8px; }
        .details-body::-webkit-scrollbar-track { background: #f1f1f1; }
        .details-body::-webkit-scrollbar-thumb { background: #ccc; border-radius: 4px; }
        .details-footer { padding: 15px 20px; border-top: 1px solid #eee; display: flex; justify-content: flex-end; gap: 10px; background: #f9f9f9; border-radius: 0 0 8px 8px; }
        .close-details { color: #aaa; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1; }
        
        .link-list-container { display: flex; flex-direction: column; gap: 10px; }
        .link-row { display: grid; grid-template-columns: 80px 340px auto auto; gap: 15px; align-items: center; justify-content: center; border-bottom: 1px solid #eee; padding-bottom: 10px; }
        .link-row:last-child { border-bottom: none; }
        .link-header { display: grid; grid-template-columns: 80px 340px auto auto; gap: 15px; background: #f2f2f2; padding: 10px; font-weight: bold; border-radius: 4px; margin-bottom: 5px; justify-content: center; }
        .tbl-thumb { width: 80px; height: 80px; object-fit: cover; border-radius: 4px; cursor: zoom-in; display: block; }
        .link-text-wrapper { overflow: hidden; background: #fafafa; border: 1px solid #eee; padding: 8px; border-radius: 4px; display: flex; align-items: center; min-width: 0; max-width: 400px; }
        .link-text { overflow-x: auto; white-space: nowrap; font-family: monospace; color: #555; width: 100%; scrollbar-width: none; }
        .link-text::-webkit-scrollbar { display: none; }
        .btn-copy-sm { background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; }
        .btn-copy-sm:hover { background: #5c636a; }
        .btn-danger-sm { background: #dc3545; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer; font-size: 12px; white-space: nowrap; }
        .btn-danger-sm:hover { background: #bb2d3b; }
        .btn-footer { padding: 10px 20px; border-radius: 4px; cursor: pointer; font-size: 14px; border: none; display: flex; align-items: center; gap: 8px; color: white; font-weight: 500; }
        .btn-copy-all { background: #198754; } .btn-copy-all:hover { background: #157347; }
        .btn-excel { background: #217346; } .btn-excel:hover { background: #1a5c38; }

        /* --- CUSTOM CONFIRM MODAL --- */
        .confirm-box { background: white; width: 450px; margin: 10% auto; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .confirm-images-grid { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; max-height: 200px; overflow-y: auto; margin: 15px 0; padding: 5px; border: 1px solid #eee; border-radius: 4px; }
        .confirm-thumb { width: 60px; height: 60px; object-fit: cover; border-radius: 4px; border: 1px solid #ddd; }
        .confirm-btns { margin-top: 20px; display: flex; justify-content: center; gap: 10px; }
        .btn-yes { background: #dc3545; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; }
        .btn-no { background: #6c757d; color: white; border: none; padding: 8px 20px; border-radius: 4px; cursor: pointer; }

    </style>
</head>
<body onclick="handleGlobalClick(event)">

<div id="lightboxModal" class="modal">
    <span class="close-modal" onclick="closeLightbox()">&times;</span>
    <div class="lightbox-container" onclick="closeIfContainerClick(event)">
        <button class="lb-btn lb-prev" id="lbMidPrev" onclick="handleNavClick('prev', 'mid'); event.stopPropagation();">&#10094;</button>
        <img class="lightbox-img" id="lbImage" onclick="event.stopPropagation();">
        <button class="lb-btn lb-next" id="lbMidNext" onclick="handleNavClick('next', 'mid'); event.stopPropagation();">&#10095;</button>
        <div class="lb-bottom-bar" onclick="event.stopPropagation();">
            <div class="lb-left-group">
                <button class="lb-trash" onclick="deleteFromLightbox()" title="Sil (Delete)">
                    <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                </button>
            </div>
            <div class="lb-center-group">
                <div class="lb-zoom-group">
                    <button class="lb-zoom-btn" onmousedown="startZoom(-0.1)" onmouseup="stopZoom()" onmouseleave="stopZoom()">-</button>
                    <button class="lb-zoom-btn" onmousedown="startZoom(0.1)" onmouseup="stopZoom()" onmouseleave="stopZoom()">+</button>
                </div>
                <button class="lb-copy" id="lbCopyBtn" onclick="copyFromLightbox()" title="Kısayol: C">Linki Kopyala</button>
            </div>
            <div class="lb-right-group">
                <button class="lb-mini-nav" id="lbBotPrev" onclick="handleNavClick('prev', 'bot')">&#10094;</button>
                <button class="lb-mini-nav" id="lbBotNext" onclick="handleNavClick('next', 'bot')">&#10095;</button>
            </div>
        </div>
    </div>
</div>

<div id="detailsModal" class="modal" onclick="closeIfBackdrop(event, 'detailsModal')">
    <div class="details-modal-content">
        <div class="details-header">
            <h3 data-lang="modalTitle" style="margin:0;">Oluşturulan Linkler</h3>
            <span class="close-details" onclick="closeDetails()">&times;</span>
        </div>
        <div class="details-body">
            <div class="link-header">
                <span data-lang="thImage">Resim</span>
                <span data-lang="thDirect">Direkt Link</span>
                <span></span><span></span>
            </div>
            <div id="detailsList" class="link-list-container"></div>
        </div>
        <div class="details-footer">
            <button class="btn-footer btn-excel" onclick="exportToExcel()">
                <svg style="width:16px;height:16px;fill:white" viewBox="0 0 24 24"><path d="M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z"/></svg>
                <span data-lang="btnExcel">Excel İndir</span>
            </button>
            <button class="btn-footer btn-copy-all" onclick="copyAllLinks()">
                <svg style="width:16px;height:16px;fill:white" viewBox="0 0 24 24"><path d="M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12V1zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2zm0 16H8V7h11v14z"/></svg>
                <span data-lang="btnCopyAll">Tümünü Kopyala</span>
            </button>
        </div>
    </div>
</div>

<div id="confirmModal" class="modal" onclick="closeIfBackdrop(event, 'confirmModal')">
    <div class="confirm-box">
        <h3 id="confirmTitle" style="margin-top:0;">Onay</h3>
        <p id="confirmMsg">Bu işlem geri alınamaz.</p>
        <div id="confirmImagesContainer" class="confirm-images-grid"></div>
        <div class="confirm-btns">
            <button class="btn-yes" id="btnConfirmYes">Evet, Sil (Enter)</button>
            <button class="btn-no" onclick="closeConfirm()">İptal (Esc/Backspace)</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="lang-wrapper">
        <button class="lang-btn" onclick="toggleLangMenu(event)">
            <svg class="lang-icon" viewBox="0 0 16 16"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zM2.04 4.326c.325 1.329 2.532 2.54 6.354 2.919V5.256c-4.42-1.379-6.354-2.919-6.354-2.919zm.344 7.625c.325-1.329 2.532-2.54 6.354-2.919v5.733c-3.822-.38-6.029-1.59-6.354-2.919zm11.576-7.625c-.325 1.329-2.532 2.54-6.354 2.919V5.256c4.42-1.379 6.354-2.919 6.354-2.919zm-.344 7.625c-.325-1.329-2.532-2.54-6.354-2.919v5.733c3.822-.38 6.029-1.59 6.354-2.919z"/><path fill-rule="evenodd" d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8zm7.5-6.923c-.67.204-1.335.82-1.887 1.855A7.97 7.97 0 0 0 5.145 4H7.5V1.077zM4.09 4a9.267 9.267 0 0 1 .64-1.539 6.7 6.7 0 0 1 .597-.933A7.025 7.025 0 0 0 2.255 4H4.09zm-.582 3.5c.03-.877.138-1.718.312-2.5H1.674a6.958 6.958 0 0 0-.656 2.5h2.49zM4.847 5a12.5 12.5 0 0 0-.338 2.5H7.5V5H4.847zM8.5 5v2.5h2.99a12.495 12.495 0 0 0-.337-2.5H8.5zM4.51 8.5a12.5 12.5 0 0 0 .337 2.5H7.5V8.5H4.51zm3.99 0V11h2.653c.187-.765.306-1.608.338-2.5H8.5zM5.145 12c.138.386.295.744.468 1.068.552 1.035 1.218 1.65 1.887 1.855V12H5.145zm.182 2.472a6.696 6.696 0 0 1-.597-.933A9.268 9.268 0 0 1 4.09 12H2.255a7.024 7.024 0 0 0 3.072 2.472zM3.82 11a13.652 13.652 0 0 1-.312-2.5h-2.49c.062.89.291 1.733.656 2.5H3.82zm6.853 3.472A7.024 7.024 0 0 0 13.745 12H11.91a9.27 9.27 0 0 1-.64 1.539 6.688 6.688 0 0 1-.597.933zM10.855 4a7.966 7.966 0 0 0-.468-1.068C9.835 1.897 9.17 1.282 8.5 1.077V4h2.355z"/></svg>
            <span id="currentLangLabel">TR</span>
        </button>
        <ul class="lang-list" id="langList">
            <li onclick="selectLang('tr')">Türkçe</li>
            <li onclick="selectLang('en')">English</li>
            <li onclick="selectLang('de')">Deutsch</li>
            <li onclick="selectLang('es')">Español</li>
            <li onclick="selectLang('fr')">Français</li>
        </ul>
    </div>

    <h3 style="margin-top:0; padding-right: 80px;" data-lang="title">Google Drive Resim Linki Dönüştürücü</h3>
    
    <label class="label" data-lang="labelInput">Normal Drive Linki:</label>
    <div class="input-group">
        <input type="text" id="driveLink" placeholder="Linkleri buraya yapıştırın (Virgülle ayırabilirsiniz)..." onclick="this.select()" oninput="dinamikKontrol()">
        <button class="paste-btn" id="btnPaste" onclick="yapistir()" title="Panodan Yapıştır">
            <svg viewBox="0 0 24 24"><path d="M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm7 16H5V5h2v1c0 .55.45 1 1 1h8c.55 0 1-.45 1-1V5h2v14z"/></svg>
        </button>
    </div>
    
    <button id="btnConvert" class="convert-btn" onclick="linkDonustur()" data-lang="btnConvert">Dönüştür</button>

    <div id="infoTip">
        <span id="infoText" data-lang="infoText">Direkt resim urllerini kopyalamak istediğiniz resimlerin üzerindeki url simgesini tıklayınız</span>
        <span class="info-close" onclick="closeInfoTip()">&times;</span>
    </div>

    <div id="cardsArea">
        <div class="result-batch-container">
            <div id="batchHeader" class="batch-title"></div>
            <div id="cardsList"></div>
        </div>
    </div>

    <div id="galleryArea">
        <label class="label" id="galleryLabel" data-lang="galleryTitleAll">Tüm Resimler:</label>
        <div class="gallery-grid" id="galleryGrid"></div>
        <div class="batch-controls" id="batchControls">
            <button class="btn-delete-selected" id="btnDelSel" onclick="confirmDeleteSelected()" data-lang="btnDeleteSelected">Seçilenleri Sil</button>
            <div style="display:flex; gap:10px; margin-left:auto;">
                <button class="btn-primary-soft" onclick="showDetails()" data-lang="btnDetails">Detaylı Liste</button>
                <button class="btn-outline-danger" onclick="confirmClearGallery()" id="btnClearAll" data-lang="btnClear">Tümünü Temizle</button>
            </div>
        </div>
    </div>
</div>

<script>
    let history = []; 
    let currentLang = 'tr';
    let dinamikModAktif = false; 
    let activeLightboxIndex = 0; 
    let lastAddedIds = []; 
    let selectedIndices = []; 
    let currentZoom = 1; 
    let navPreference = 'mid'; 
    let isTipClosed = false; 
    let isCardExpanded = true; // İlk yüklemede açık gelsin
    
    navPreference = Math.random() > 0.5 ? 'mid' : 'bot';
    let zoomInterval = null; 
    const driveRegex = /drive\.google\.com\/.*?\/d\/([a-zA-Z0-9_-]{25,})/;

    const translations = {
        tr: { title: "Google Drive Resim Linki Dönüştürücü", labelInput: "Normal Drive Linki:", placeholder: "Linkleri buraya yapıştırın (Virgülle ayırabilirsiniz)...", btnConvert: "Dönüştür", btnDetails: "Detaylı Liste", btnClear: "Tümünü Temizle", btnReset: "Sıfırla", btnDeleteSelected: "Seçilenleri Sil", errEmpty: "Link Girilmedi!", errInvalid: "Geçersiz Link!", msgCopied: "Kopyalandı!", btnCopy: "Kopyala", modalTitle: "Oluşturulan Linkler", thImage: "Resim", thDirect: "Direkt Link", thAction: "İşlem", btnDelete: "Sil", btnCopyAll: "Tümünü Kopyala", btnExcel: "Excel İndir", confirmTitle: "Silme Onayı", confirmDelAll: "Tüm galeri silinecek. Emin misiniz?", confirmDelOne: "Bu resmi silmek istediğinize emin misiniz?", confirmDelSel: "Seçilen resimleri silmek istediğinize emin misiniz?", btnYes: "Evet, Sil", btnNo: "İptal", pasteTooltip: "Panodan Yapıştır", galleryTitleAll: "Tüm Resimler:", infoText: "Direkt resim urllerini kopyalamak istediğiniz resimlerin üzerindeki url simgesini tıklayınız", titleSingle: "Direkt Resim Linki", titleMulti: "Direkt Resim Linkleri" },
        en: { title: "Google Drive Direct Link Generator", labelInput: "Original Drive Link:", placeholder: "Paste links here (comma separated)...", btnConvert: "Convert", btnDetails: "Detailed List", btnClear: "Clear All", btnReset: "Reset", btnDeleteSelected: "Delete Selected", errEmpty: "No Link Entered!", errInvalid: "Invalid Link!", msgCopied: "Copied!", btnCopy: "Copy", modalTitle: "Generated Links", thImage: "Image", thDirect: "Direct Link", thAction: "Action", btnDelete: "Delete", btnCopyAll: "Copy All", btnExcel: "Download Excel", confirmTitle: "Delete Confirmation", confirmDelAll: "All gallery will be deleted. Are you sure?", confirmDelOne: "Are you sure you want to delete this image?", confirmDelSel: "Are you sure you want to delete selected images?", btnYes: "Yes, Delete", btnNo: "Cancel", pasteTooltip: "Paste from Clipboard", galleryTitleAll: "All Images:", infoText: "Click the url icon on the images to copy direct image urls", titleSingle: "Direct Image Link", titleMulti: "Direct Image Links" },
        de: { title: "Google Drive Direktlink-Generator", labelInput: "Original-Link:", placeholder: "Links hier einfügen...", btnConvert: "Umwandeln", btnDetails: "Detaillierte Liste", btnClear: "Alles löschen", btnReset: "Zurücksetzen", btnDeleteSelected: "Ausgewählte löschen", errEmpty: "Kein Link eingegeben!", errInvalid: "Ungültiger Link!", msgCopied: "Kopiert!", btnCopy: "Kopieren", modalTitle: "Generierte Links", thImage: "Bild", thDirect: "Direktlink", thAction: "Aktion", btnDelete: "Löschen", btnCopyAll: "Alles Kopieren", btnExcel: "Excel Herunterladen", confirmTitle: "Löschbestätigung", confirmDelAll: "Die gesamte Galerie wird gelöscht. Sind Sie sicher?", confirmDelOne: "Möchten Sie dieses Bild wirklich löschen?", confirmDelSel: "Möchten Sie die ausgewählten Bilder löschen?", btnYes: "Ja, Löschen", btnNo: "Abbrechen", pasteTooltip: "Aus Zwischenablage einfügen", galleryTitleAll: "Alle Bilder:", infoText: "Klicken Sie auf das URL-Symbol auf den Bildern, um direkte Bild-URLs zu kopieren", titleSingle: "Direkter Bildlink", titleMulti: "Direkte Bildlinks" },
        fr: { title: "Générateur de liens directs Drive", labelInput: "Lien Original:", placeholder: "Collez les liens ici...", btnConvert: "Convertir", btnDetails: "Liste détaillée", btnClear: "Tout effacer", btnReset: "Réinitialiser", btnDeleteSelected: "Supprimer la sélection", errEmpty: "Aucun lien saisi !", errInvalid: "Lien invalide !", msgCopied: "Copié !", btnCopy: "Copier", modalTitle: "Liens générés", thImage: "Image", thDirect: "Lien direct", thAction: "Action", btnDelete: "Supprimer", btnCopyAll: "Tout Copier", btnExcel: "Télécharger Excel", confirmTitle: "Confirmation de suppression", confirmDelAll: "Toute la galerie sera supprimée. Êtes-vous sûr ?", confirmDelOne: "Êtes-vous sûr de vouloir supprimer cette image ?", confirmDelSel: "Êtes-vous sûr de vouloir supprimer les images sélectionnées ?", btnYes: "Oui, Supprimer", btnNo: "Annuler", pasteTooltip: "Coller depuis le presse-papiers", galleryTitleAll: "Toutes les images :", infoText: "Cliquez sur l'icône url sur les images pour copier les urls directes des images", titleSingle: "Lien direct", titleMulti: "Liens directs" },
        es: { title: "Generador de Enlaces Directos Drive", labelInput: "Enlace Original:", placeholder: "Pega los enlaces aquí...", btnConvert: "Convertir", btnDetails: "Lista Detallada", btnClear: "Borrar Todo", btnReset: "Reiniciar", btnDeleteSelected: "Eliminar Seleccionados", errEmpty: "¡Enlace no introducido!", errInvalid: "¡Enlace Inválido!", msgCopied: "¡Copiado!", btnCopy: "Copiar", modalTitle: "Enlaces Generados", thImage: "Imagen", thDirect: "Enlace Directo", thAction: "Acción", btnDelete: "Eliminar", btnCopyAll: "Copiar Todo", btnExcel: "Descargar Excel", confirmTitle: "Confirmación de eliminación", confirmDelAll: "¿Se eliminará toda la galería. Estás seguro?", confirmDelOne: "¿Estás seguro de que quieres eliminar esta imagen?", confirmDelSel: "¿Estás seguro de que quieres eliminar las imágenes seleccionadas?", btnYes: "Sí, Eliminar", btnNo: "Cancelar", pasteTooltip: "Pegar desde portapapeles", galleryTitleAll: "Todas las imágenes:", infoText: "Haga clic en el icono de url en las imágenes para copiar las urls directas de las imágenes", titleSingle: "Enlace directo", titleMulti: "Enlaces directos" },
        zh: { title: "Google Drive 直接链接生成器", labelInput: "原始 Drive 链接：", placeholder: "在此处粘贴链接...", btnConvert: "转换", btnDetails: "详细列表", btnClear: "全部清除", btnReset: "重置", btnDeleteSelected: "删除所选", errEmpty: "未输入链接！", errInvalid: "无效链接！", msgCopied: "已复制！", btnCopy: "复制", modalTitle: "生成的链接", thImage: "图片", thDirect: "直接链接", thAction: "操作", btnDelete: "删除", btnCopyAll: "复制全部", btnExcel: "下载 Excel", confirmTitle: "删除确认", confirmDelAll: "所有图库都将被删除。你确定吗？", confirmDelOne: "您确定要删除此图片吗？", confirmDelSel: "您确定要删除所选图片吗？", btnYes: "是，删除", btnNo: "取消", pasteTooltip: "从剪贴板粘贴", galleryTitleAll: "所有图像：", infoText: "点击图片上的 url 图标以复制直接图片 url", titleSingle: "直接图片链接", titleMulti: "直接图片链接" },
        ru: { title: "Генератор прямых ссылок Drive", labelInput: "Исходная ссылка:", placeholder: "Вставьте ссылки сюда...", btnConvert: "Конвертировать", btnDetails: "Подробный список", btnClear: "Очистить все", btnReset: "Сброс", btnDeleteSelected: "Удалить выбранные", errEmpty: "Ссылка не введена!", errInvalid: "Неверная ссылка!", msgCopied: "Скопировано!", btnCopy: "Копировать", modalTitle: "Созданные ссылки", thImage: "Изображение", thDirect: "Прямая ссылка", thAction: "Действие", btnDelete: "Удалить", btnCopyAll: "Копировать все", btnExcel: "Скачать Excel", confirmTitle: "Подтверждение удаления", confirmDelAll: "Вся галерея будет удалена. Вы уверены?", confirmDelOne: "Вы уверены, что хотите удалить это изображение?", confirmDelSel: "Вы уверены, что хотите удалить выбранные изображения?", btnYes: "Да, удалить", btnNo: "Отмена", pasteTooltip: "Вставить из буфера", galleryTitleAll: "Все изображения:", infoText: "Нажмите на значок url на изображениях, чтобы скопировать прямые url изображений", titleSingle: "Прямая ссылка", titleMulti: "Прямые ссылки" },
        ar: { title: "محول روابط جوجل درايف", labelInput: "رابط درايف الأصلي:", placeholder: "الصق الروابط هنا...", btnConvert: "تحويل", btnDetails: "قائمة مفصلة", btnClear: "مسح الكل", btnReset: "إعادة ضبط", btnDeleteSelected: "حذف المختار", errEmpty: "لم يتم إدخال رابط!", errInvalid: "رابط غير صالح!", msgCopied: "تم النسخ!", btnCopy: "نسخ", modalTitle: "الروابط التي تم إنشاؤها", thImage: "صورة", thDirect: "رابط مباشر", thAction: "عمل", btnDelete: "حذف", btnCopyAll: "نسخ الكل", btnExcel: "تحميل إكسل", confirmTitle: "تأكيد الحذف", confirmDelAll: "سيتم حذف كل المعرض. هل أنت متأكد؟", confirmDelOne: "هل أنت متأكد أنك تريد حذف هذه الصورة؟", confirmDelSel: "هل أنت متأكد أنك تريد حذف الصور المحددة؟", btnYes: "نعم، حذف", btnNo: "إلغاء", pasteTooltip: "لصق من الحافظة", galleryTitleAll: "كل الصور:", infoText: "انقر فوق رمز url على الصور لنسخ عناوين url المباشرة للصور", titleSingle: "رابط مباشر", titleMulti: "روابط مباشرة" },
        hi: { title: "Google Drive डायरेक्ट लिंक जेनरेटर", labelInput: "मूल ड्राइव लिंक:", placeholder: "लिंक यहाँ पेस्ट करें...", btnConvert: "बदलें", btnDetails: "विस्तृत सूची", btnClear: "सभी साफ करें", btnReset: "रीसेट", btnDeleteSelected: "चयनित हटाएं", errEmpty: "लिंक दर्ज नहीं किया गया!", errInvalid: "अमान्य लिंक!", msgCopied: "कॉपी हो गया!", btnCopy: "कॉपी", modalTitle: "उत्पन्न लिंक", thImage: "छवि", thDirect: "डायरेक्ट लिंक", thAction: "कार्रवाई", btnDelete: "हटाएं", btnCopyAll: "सभी कॉपी करें", btnExcel: "एक्सेल डाउनलोड करें", confirmTitle: "हटाने की पुष्टि", confirmDelAll: "पूरी गैलरी हटा दी जाएगी। क्या आपको यकीन है?", confirmDelOne: "क्या आप वाकई इस छवि को हटाना चाहते हैं?", confirmDelSel: "क्या आप वाकई चयनित छवियों को हटाना चाहते हैं?", btnYes: "हाँ, हटाएं", btnNo: "रद्द करें", pasteTooltip: "क्लिपबोर्ड से चिपकाएं", galleryTitleAll: "सभी चित्र:", infoText: "प्रत्यक्ष छवि url कॉपी करने के लिए छवियों पर url आइकन पर क्लिक करें", titleSingle: "डायरेक्ट लिंक", titleMulti: "डायरेक्ट लिंक्स" },
        pt: { title: "Gerador de Links Diretos Drive", labelInput: "Link Original:", placeholder: "Cole os links aqui...", btnConvert: "Converter", btnDetails: "Lista Detalhada", btnClear: "Limpar Tudo", btnReset: "Redefinir", btnDeleteSelected: "Excluir Selecionados", errEmpty: "Nenhum link inserido!", errInvalid: "Link Inválido!", msgCopied: "Copiado!", btnCopy: "Copiar", modalTitle: "Links Gerados", thImage: "Imagem", thDirect: "Link Direto", thAction: "Ação", btnDelete: "Excluir", btnCopyAll: "Copiar Tudo", btnExcel: "Baixar Excel", confirmTitle: "Confirmação de Exclusão", confirmDelAll: "Toda a galeria será excluída. Tem certeza?", confirmDelOne: "Tem certeza de que deseja excluir esta imagem?", confirmDelSel: "Tem certeza de que deseja excluir as imagens selecionadas?", btnYes: "Sim, Excluir", btnNo: "Cancelar", pasteTooltip: "Colar da área de transferência", galleryTitleAll: "Todas as imagens:", infoText: "Clique no ícone de url nas imagens para copiar os urls diretos das imagens", titleSingle: "Link Direto", titleMulti: "Links Diretos" },
        ja: { title: "Google Drive 直リンク作成ツール", labelInput: "元のリンク:", placeholder: "ここにリンクを貼り付け...", btnConvert: "変換", btnDetails: "詳細リスト", btnClear: "すべてクリア", btnReset: "リセット", btnDeleteSelected: "選択項目を削除", errEmpty: "リンク未入力！", errInvalid: "無効なリンクです!", msgCopied: "コピーしました!", btnCopy: "コピー", modalTitle: "生成されたリンク", thImage: "画像", thDirect: "直リンク", thAction: "操作", btnDelete: "削除", btnCopyAll: "すべてコピー", btnExcel: "Excelをダウンロード", confirmTitle: "削除の確認", confirmDelAll: "すべてのギャラリーが削除されます。よろしいですか？", confirmDelOne: "この画像を削除してもよろしいですか？", confirmDelSel: "選択した画像を削除してもよろしいですか？", btnYes: "はい、削除", btnNo: "キャンセル", pasteTooltip: "クリップボードから貼り付け", galleryTitleAll: "すべての画像:", infoText: "画像のurlアイコンをクリックして、直リンクをコピーします", titleSingle: "直リンク", titleMulti: "直リンク" }
    };

    function handleGlobalClick(e) {
        if(e.target.classList.contains('modal')) {
            if(e.target.id === 'lightboxModal') closeLightbox();
            if(e.target.id === 'detailsModal') closeDetails();
            if(e.target.id === 'confirmModal') closeConfirm();
        }
        let l = document.getElementById("langList");
        let b = document.querySelector(".lang-btn");
        if(l.style.display === "block" && !l.contains(e.target) && !b.contains(e.target)) {
            l.style.display = "none";
        }
        if(selectedIndices.length > 0) {
            if(!e.target.closest('.gallery-item') && !e.target.closest('#btnDelSel')) {
                selectedIndices = []; updateUI(); 
            }
        }
    }

    function toggleLangMenu(e) { e.stopPropagation(); var l = document.getElementById("langList"); l.style.display = (l.style.display === "block") ? "none" : "block"; }
    function selectLang(c) { currentLang = c; document.getElementById("langList").style.display = "none"; applyTranslations(); }

    function applyTranslations() {
        const t = translations[currentLang];
        document.querySelectorAll('[data-lang]').forEach(el => { if (t[el.getAttribute('data-lang')]) el.innerText = t[el.getAttribute('data-lang')]; });
        document.getElementById('driveLink').placeholder = t.placeholder;
        let lbCopy = document.getElementById('lbCopyBtn'); if(!lbCopy.innerText.includes("!")) lbCopy.innerText = t.btnCopy;
        var btnConvert = document.getElementById('btnConvert'); if (!btnConvert.classList.contains('error-shake')) btnConvert.innerText = t.btnConvert;
        document.getElementById('infoText').innerText = t.infoText;
        if(document.getElementById("detailsModal").style.display === "block") showDetails(); 
        updateUI();
    }

    function closeIfBackdrop(e, modalId) {
        if(e.target === document.getElementById(modalId)) {
            if(modalId === 'lightboxModal') closeLightbox();
            if(modalId === 'detailsModal') closeDetails();
            if(modalId === 'confirmModal') closeConfirm();
        }
    }
    
    function closeIfContainerClick(e) {
        if(e.target.classList.contains('lightbox-container')) closeLightbox();
    }

    function closeInfoTip() {
        document.getElementById("infoTip").style.display = "none";
        isTipClosed = true;
    }

    function toggleCardExpansion() {
        isCardExpanded = !isCardExpanded;
        // Iconu döndür
        let btn = document.querySelector('.expand-btn');
        if(btn) {
            if(isCardExpanded) {
                btn.classList.add('rotated');
            } else {
                btn.classList.remove('rotated');
            }
        }
        updateUI();
    }

    function linkDonustur() {
        var btn = document.getElementById("btnConvert");
        if(btn.classList.contains('passive')) return;
        var inputElement = document.getElementById("driveLink");
        var rawInput = inputElement.value.trim();
        const t = translations[currentLang];

        if(rawInput === "") { hataAnimasyonu(t.errEmpty); return; }

        let links = rawInput.split(',').map(s => s.trim()).filter(s => s !== "");
        let hasValidLink = false;
        
        // Önceki durumu kaydet (First load kontrolü için)
        let wasEmpty = (history.length === 0);
        lastAddedIds = []; 

        links.forEach(val => {
            if (val.match(/\/d\/(.+?)\//) && !val.startsWith("http")) val = "https://" + val;
            let idMatch = val.match(driveRegex);
            if (idMatch) {
                hasValidLink = true;
                let fileID = idMatch[1];
                let newLink = "https://drive.google.com/thumbnail?id=" + fileID + "&sz=w10000";
                history = history.filter(item => item.id !== fileID);
                history.unshift({ id: fileID, directLink: newLink, originalLink: val });
                lastAddedIds.push(fileID);
            }
        });

        if (!hasValidLink) { hataAnimasyonu(t.errInvalid); return; }
        
        // --- İLK YÜKLEME MANTIĞI ---
        if (wasEmpty) {
            isCardExpanded = true; // İlk açılışta liste açık gelsin
        } else {
            isCardExpanded = false; // Sonraki eklemelerde kapalı gelsin
        }

        closeInfoTip();
        updateUI();
        dinamikModAktif = false; btn.classList.add("success-lock");
    }

    function updateUI() {
        const cardsArea = document.getElementById("cardsArea");
        const cardsList = document.getElementById("cardsList");
        const batchHeader = document.getElementById("batchHeader");
        
        const galleryArea = document.getElementById("galleryArea");
        const galleryGrid = document.getElementById("galleryGrid");
        const batchControls = document.getElementById("batchControls");
        const btnDelSel = document.getElementById("btnDelSel");
        const btnClearAll = document.getElementById("btnClearAll");
        const galleryLabel = document.getElementById("galleryLabel");
        const infoTip = document.getElementById("infoTip");
        const t = translations[currentLang];

        galleryGrid.innerHTML = "";
        cardsList.innerHTML = "";

        if (history.length === 0) {
            cardsArea.style.display = "none";
            galleryArea.style.display = "none";
            infoTip.style.display = "none";
            return;
        }

        // --- GÖRÜNÜM KARAR MANTIĞI V36 ---
        let isFirstLoad = (history.length === lastAddedIds.length);
        
        let showGrid = true;
        // Eğer ilk yükleme ise ve grid gizlenmeli
        if (isFirstLoad) {
            showGrid = false;
        }

        // --- KART GÖRÜNÜMÜ RENDER ---
        cardsArea.style.display = "block";
        
        let batchItems = history.filter(h => lastAddedIds.includes(h.id));
        if(lastAddedIds.length === 0 && history.length > 0) batchItems = history.slice(0, 1);

        batchHeader.innerText = (batchItems.length > 1) ? t.titleMulti : t.titleSingle;
        
        batchItems.forEach((item, index) => {
            // Daraltılmışsa sadece ilk eleman
            if (!isCardExpanded && index > 0) return;

            let row = document.createElement("div"); row.className = "result-row";

            let img = document.createElement("img"); img.src = item.directLink; img.className = "card-thumb";
            let globalIndex = history.findIndex(h => h.id === item.id);
            img.onclick = () => openLightbox(globalIndex, 'popup');

            let linkBox = document.createElement("div"); linkBox.className = "card-link-box"; linkBox.innerText = item.directLink;
            linkBox.id = "linkBox-" + item.id;
            
            // ACTION GROUP (KOPYALA + GENİŞLET) - FLEXBOX
            let actionGroup = document.createElement("div"); actionGroup.className = "card-actions";

            // 1. GENİŞLETME BUTONU (Varsa En Sola)
            if (batchItems.length > 1 && !isFirstLoad) {
                if (!isCardExpanded && index === 0) {
                    let expandBtn = document.createElement("button"); expandBtn.className = "expand-btn";
                    expandBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>';
                    expandBtn.onclick = toggleCardExpansion;
                    actionGroup.appendChild(expandBtn);
                }
                else if (isCardExpanded && index === batchItems.length - 1) {
                    let collapseBtn = document.createElement("button"); collapseBtn.className = "expand-btn rotated";
                    collapseBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M7.41 8.59L12 13.17l4.59-4.58L18 10l-6 6-6-6 1.41-1.41z"/></svg>';
                    collapseBtn.onclick = toggleCardExpansion;
                    actionGroup.appendChild(collapseBtn);
                }
            }

            // 2. KOPYALA BUTONU (En Sağa)
            let btnCopy = document.createElement("button"); btnCopy.className = "card-copy-btn"; btnCopy.innerText = t.btnCopy;
            btnCopy.onclick = function() {
                navigator.clipboard.writeText(item.directLink).then(() => {
                    // Reflow hack
                    btnCopy.classList.remove("success-copy");
                    void btnCopy.offsetWidth; 
                    
                    btnCopy.innerText = t.msgCopied; 
                    btnCopy.classList.add("success-copy");
                    
                    let lb = document.getElementById("linkBox-" + item.id);
                    if(lb) lb.classList.add("copied-text");
                    
                    // ARTIK TIMEOUT YOK (KALICI YEŞİL)
                });
            };
            actionGroup.appendChild(btnCopy);

            row.appendChild(img);
            row.appendChild(linkBox);
            row.appendChild(actionGroup);

            cardsList.appendChild(row);
        });

        // --- GRID GÖRÜNÜMÜ ---
        if (showGrid) {
            galleryArea.style.display = "block";
            batchControls.style.display = "flex";

            if (!isTipClosed) infoTip.style.display = "block"; else infoTip.style.display = "none";

            btnClearAll.innerText = t.btnClear;

            if(selectedIndices.length > 0) {
                btnDelSel.style.display = "block";
                btnDelSel.innerText = t.btnDeleteSelected + " (" + selectedIndices.length + ")";
            } else {
                btnDelSel.style.display = "none";
            }

            history.forEach((item, index) => {
                let div = document.createElement("div"); div.className = "gallery-item";
                if (selectedIndices.includes(index)) div.classList.add("selected-item");

                let img = document.createElement("img"); img.src = item.directLink;
                div.onclick = (e) => {
                    if(e.ctrlKey || e.metaKey) { toggleSelection(index); } else { openLightbox(index); }
                };

                let btn = document.createElement("div"); btn.className = "overlay-copy-btn";
                btn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z"/></svg>';
                btn.onclick = (e) => { e.stopPropagation(); copyDirect(item.directLink, btn, img); };
                div.appendChild(img); div.appendChild(btn); galleryGrid.appendChild(div);
            });
        } else {
            galleryArea.style.display = "none";
        }
    }

    function toggleSelection(index) {
        if(selectedIndices.includes(index)) { selectedIndices = selectedIndices.filter(i => i !== index); } 
        else { selectedIndices.push(index); }
        updateUI();
    }

    let confirmCallback = null;
    function showConfirm(msg, images, callback) {
        const t = translations[currentLang];
        document.getElementById("confirmTitle").innerText = t.confirmTitle;
        document.getElementById("confirmMsg").innerText = msg;
        document.getElementById("btnConfirmYes").innerText = t.btnYes;
        document.querySelector(".btn-no").innerText = t.btnNo;
        
        let container = document.getElementById("confirmImagesContainer");
        container.innerHTML = "";
        if(images) {
            let imgList = Array.isArray(images) ? images : [images];
            imgList.forEach(src => {
                let img = document.createElement("img");
                img.src = src; img.className = "confirm-thumb";
                container.appendChild(img);
            });
            container.style.display = "flex";
        } else { container.style.display = "none"; }
        
        confirmCallback = callback;
        document.getElementById("confirmModal").style.display = "block";
        document.getElementById("btnConfirmYes").focus();
    }
    
    document.addEventListener('keydown', function(e) {
        if(document.getElementById("lightboxModal").style.display === "block") lightboxKeyHandler(e);
        else if(document.getElementById("confirmModal").style.display === "block") {
            if(e.key === "Enter") { e.preventDefault(); if(confirmCallback) confirmCallback(); closeConfirm(); }
            if(e.key === "Escape" || e.key === "Delete" || e.key === "Backspace") closeConfirm();
        }
        else if(document.getElementById("confirmModal").style.display !== "block") {
            if(e.ctrlKey && e.key === "Delete") { if(history.length > 0) confirmClearGallery(); } 
            else if(e.key === "Delete") { if(selectedIndices.length > 0) confirmDeleteSelected(); }
        }
    });

    document.getElementById("btnConfirmYes").onclick = function() { if(confirmCallback) confirmCallback(); closeConfirm(); };
    function closeConfirm() { document.getElementById("confirmModal").style.display = "none"; confirmCallback = null; }

    function confirmClearGallery() {
        const t = translations[currentLang];
        let allImgs = history.map(h => h.directLink);
        showConfirm(t.confirmDelAll, allImgs, function() {
            history = []; lastAddedIds = []; selectedIndices = [];
            closeInfoTip(); 
            updateUI();
            document.getElementById("driveLink").value = "";
            document.getElementById("btnConvert").classList.remove("success-lock");
        });
    }

    function confirmDeleteSelected() {
        const t = translations[currentLang];
        let selectedImgs = selectedIndices.map(idx => history[idx].directLink);
        showConfirm(t.confirmDelSel, selectedImgs, function() {
            selectedIndices.sort((a, b) => b - a);
            selectedIndices.forEach(idx => history.splice(idx, 1));
            selectedIndices = []; updateUI();
        });
    }

    function deleteFromLightbox() {
        const t = translations[currentLang];
        showConfirm(t.confirmDelOne, history[activeLightboxIndex].directLink, function() {
            let deletedId = history[activeLightboxIndex].id;
            history.splice(activeLightboxIndex, 1);
            lastAddedIds = lastAddedIds.filter(id => id !== deletedId);
            if(activeLightboxIndex >= history.length) activeLightboxIndex = history.length - 1;
            updateUI();
            if(history.length === 0) closeLightbox(); else updateLightboxContent();
        });
    }

    function openLightbox(index, fromSource = 'gallery') {
        activeLightboxIndex = index;
        updateLightboxContent();
        let modal = document.getElementById("lightboxModal");
        modal.style.display = "block";
        modal.addEventListener("wheel", handleWheel, { passive: false });
        if(fromSource === 'popup') modal.classList.add("hide-nav"); else modal.classList.remove("hide-nav");
    }
    
    function closeLightbox() {
        document.getElementById("lightboxModal").style.display = "none";
        document.getElementById("lightboxModal").removeEventListener("wheel", handleWheel);
    }
    
    function updateLightboxContent() {
        if (history.length === 0) { closeLightbox(); return; }
        if (activeLightboxIndex >= history.length) activeLightboxIndex = 0;
        if (activeLightboxIndex < 0) activeLightboxIndex = history.length - 1;
        
        let item = history[activeLightboxIndex];
        let img = document.getElementById("lbImage");
        img.style.transition = 'none'; 
        currentZoom = 1; img.style.transform = `scale(${currentZoom})`;
        img.src = item.directLink;
        setTimeout(() => { img.style.transition = 'transform 0.1s linear'; }, 10);

        const t = translations[currentLang];
        let btn = document.getElementById("lbCopyBtn");
        btn.innerText = t.btnCopy; btn.style.backgroundColor = "#fd7e14";
    }

    function handleNavClick(directionStr, type) {
        navPreference = type;
        let dir = directionStr === 'next' ? 1 : -1;
        changeSlide(dir);
    }

    function changeSlide(direction) {
        if(history.length === 0) return;
        activeLightboxIndex += direction;
        updateLightboxContent();
    }

    function startZoom(amount) {
        if (zoomInterval) return;
        zoomImage(amount);
        zoomInterval = setInterval(() => zoomImage(amount), 100);
    }

    function stopZoom() {
        if (zoomInterval) { clearInterval(zoomInterval); zoomInterval = null; }
    }

    function zoomImage(amount) {
        currentZoom += amount;
        if (currentZoom < 0.5) currentZoom = 0.5; if (currentZoom > 5) currentZoom = 5;
        document.getElementById("lbImage").style.transform = `scale(${currentZoom})`;
    }

    function handleWheel(e) {
        e.preventDefault();
        if (e.deltaY < 0) zoomImage(0.2); else zoomImage(-0.2);
    }

    let activeZoomKey = null; 

    function lightboxKeyHandler(e) {
        if(!document.getElementById("lightboxModal").classList.contains("hide-nav")) {
            if (e.key === "ArrowRight") { changeSlide(1); let b = document.getElementById(navPreference === 'mid' ? 'lbMidNext' : 'lbBotNext'); if(b) { b.classList.add("key-active"); setTimeout(()=>b.classList.remove("key-active"),150); } }
            if (e.key === "ArrowLeft") { changeSlide(-1); let b = document.getElementById(navPreference === 'mid' ? 'lbMidPrev' : 'lbBotPrev'); if(b) { b.classList.add("key-active"); setTimeout(()=>b.classList.remove("key-active"),150); } }
        }
        if (e.key === "Escape") closeLightbox();
        if (e.key.toLowerCase() === "c") copyFromLightbox();
        if (e.key === "Delete" || e.key === "Backspace") deleteFromLightbox();
        
        if ((e.key === "+" || e.key === "Add" || e.key === "-" || e.key === "Subtract") && !e.repeat) {
            if (activeZoomKey) return; 
            activeZoomKey = e.key;
            let amount = (e.key === "+" || e.key === "Add") ? 0.2 : -0.2;
            startZoom(amount);
        }
    }
    
    document.addEventListener('keyup', (e) => {
        if (e.key === activeZoomKey || e.key === "+" || e.key === "Add" || e.key === "-" || e.key === "Subtract") {
            stopZoom();
            activeZoomKey = null;
        }
    });

    function copyFromLightbox() {
        let link = history[activeLightboxIndex].directLink;
        let btn = document.getElementById("lbCopyBtn");
        const t = translations[currentLang];
        navigator.clipboard.writeText(link).then(() => {
            btn.innerText = t.msgCopied; btn.style.backgroundColor = "#198754";
            setTimeout(() => { btn.innerText = t.btnCopy; btn.style.backgroundColor = "#fd7e14"; }, 1500);
        });
    }

    function showDetails() {
        const listContainer = document.getElementById("detailsList");
        const t = translations[currentLang];
        listContainer.innerHTML = "";
        history.forEach((item, index) => {
            let row = document.createElement("div"); row.className = "link-row";
            let img = document.createElement("img"); img.src = item.directLink; img.className = "tbl-thumb";
            img.onclick = () => { openLightbox(index, 'popup'); };
            let divWrap = document.createElement("div"); divWrap.className = "link-text-wrapper";
            let spanLink = document.createElement("div"); spanLink.className = "link-text"; spanLink.innerText = item.directLink;
            divWrap.appendChild(spanLink);
            let btnCopy = document.createElement("button"); btnCopy.className = "btn-copy-sm"; btnCopy.innerText = t.btnCopy;
            btnCopy.onclick = () => {
                navigator.clipboard.writeText(item.directLink).then(() => {
                    btnCopy.innerText = t.msgCopied; btnCopy.style.backgroundColor = "#198754";
                    setTimeout(() => { btnCopy.innerText = t.btnCopy; btnCopy.style.backgroundColor = "#6c757d"; }, 1000);
                });
            };
            let btnDel = document.createElement("button"); btnDel.className = "btn-danger-sm"; btnDel.innerText = t.btnDelete;
            btnDel.onclick = () => {
                showConfirm(t.confirmDelOne, item.directLink, function() {
                    let deletedId = history[index].id;
                    history.splice(index, 1);
                    lastAddedIds = lastAddedIds.filter(id => id !== deletedId);
                    updateUI(); 
                    if(history.length === 0) closeDetails(); else showDetails();
                });
            };
            row.appendChild(img); row.appendChild(divWrap); row.appendChild(btnCopy); row.appendChild(btnDel);
            listContainer.appendChild(row);
        });
        document.getElementById("detailsModal").style.display = "block";
    }

    function copyAllLinks() {
        const t = translations[currentLang];
        let allLinks = history.map(item => item.directLink).join("\n");
        navigator.clipboard.writeText(allLinks).then(() => {
            let btn = document.querySelector(".btn-copy-all span");
            btn.innerText = t.msgCopied; setTimeout(() => { btn.innerText = t.btnCopyAll; }, 1500);
        });
    }

    function exportToExcel() {
        let tableHTML = `
            <html xmlns:o="urn:schemas-microsoft-com:office:office" xmlns:x="urn:schemas-microsoft-com:office:excel" xmlns="http://www.w3.org/TR/REC-html40">
            <head><meta charset="UTF-8"></head>
            <body>
            <table border="1" style="text-align:center;">
                <thead><tr><th style="width:120px;">Image</th><th>Direct Link</th><th>Original Link</th></tr></thead>
                <tbody>
        `;
        history.forEach(item => {
            tableHTML += `
                <tr height="100">
                    <td align="center" valign="middle" style="text-align:center; vertical-align:middle;">
                        <img src="${item.directLink}" width="100" height="100">
                    </td>
                    <td valign="middle" style="vertical-align:middle; text-align:center;">
                        <a href="${item.directLink}">${item.directLink}</a>
                    </td>
                    <td valign="middle" style="vertical-align:middle;">
                        <a href="${item.originalLink}">${item.originalLink}</a>
                    </td>
                </tr>
            `;
        });
        tableHTML += `</tbody></table></body></html>`;
        let blob = new Blob([tableHTML], { type: 'application/vnd.ms-excel' });
        let link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "drive_gallery_visual.xls";
        document.body.appendChild(link); link.click(); document.body.removeChild(link);
    }

    function closeDetails() { document.getElementById("detailsModal").style.display = "none"; }
    function copyDirect(link, btnElement, imgElement) {
        navigator.clipboard.writeText(link).then(() => {
            let originalBg = btnElement.style.background;
            btnElement.style.background = "#198754"; btnElement.style.color = "white";
            setTimeout(() => { btnElement.style.background = ""; btnElement.style.color = ""; }, 500);
        });
    }

    function dinamikKontrol() {
        document.getElementById("btnConvert").classList.remove("success-lock");
        if (!dinamikModAktif) return;
        var val = document.getElementById("driveLink").value.trim();
        var btn = document.getElementById("btnConvert");
        const t = translations[currentLang];
        if (val === "") { btn.classList.add("passive"); btn.innerText = t.errEmpty; return; }
        if (!val.match(driveRegex)) { btn.classList.add("passive"); btn.innerText = t.errInvalid; } 
        else { btn.classList.remove("passive"); btn.innerText = t.btnConvert; }
    }

    function hataAnimasyonu(mesaj) {
        var btn = document.getElementById("btnConvert");
        btn.classList.remove("success-lock"); btn.classList.add("error-shake"); btn.innerText = mesaj; dinamikModAktif = true;
        setTimeout(() => { btn.classList.remove("error-shake"); btn.classList.add("passive"); }, 1000);
    }

    async function yapistir() {
        var inputAlani = document.getElementById("driveLink");
        var pasteBtn = document.getElementById("btnPaste");
        try {
            const text = await navigator.clipboard.readText();
            inputAlani.value = text; dinamikKontrol();
            pasteBtn.style.backgroundColor = "#198754"; setTimeout(() => pasteBtn.style.backgroundColor = "", 1500);
            if (text.match(driveRegex)) linkDonustur();
        } catch (err) { console.error("Hata:", err); inputAlani.value = ""; dinamikKontrol(); }
    }
</script>

</body>
</html>
